<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chokaj - Plan Your Event</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

    <style>
        /* --- Styles (Keep all your existing styles) --- */
        html { height: 100%;}
        body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; color:#e0d5c8; margin:0; padding:20px; display:flex; justify-content:center; align-items:center; min-height:100vh; line-height:1.6; background:linear-gradient(-45deg, #4a3f35, #7a5f45, #3b2e26, #6a4f3a); background-size:400% 400%; animation:gradientBG 12s ease infinite; } @keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        #eventForm{ background-color:rgba(43, 36, 30, 0.9); padding:30px 40px; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.5); width:100%; max-width:600px; box-sizing:border-box; margin-bottom:20px; position:relative; border:1px solid rgba(106, 79, 58, 0.5); }
        /* Add visibility: visible; if you previously hid it, otherwise it should be visible by default */
        /* #eventForm { visibility: visible; display: block; } */ /* Typically not needed unless hidden elsewhere */

        h1,h2{color:#f0e5d8; text-align:center; margin-bottom:25px; font-weight:500} h1{margin-bottom:40px; font-size:2em; text-shadow: 1px 1px 3px rgba(0,0,0,0.4);} h2{margin-bottom:20px; font-size:1.5em; border-bottom:1px solid #6a4f3a; padding-bottom:10px} label{display:block; margin-bottom:8px; color:#b0a095; font-weight:500}
        .checkbox-group label, .radio-group label{display:inline-block; margin-right:15px; margin-bottom:0; font-weight:normal;} .checkbox-group input[type=checkbox], .radio-group input[type=radio]{margin-right:5px; vertical-align:middle; accent-color: #b08f5a;}
        input[type=text],input[type=number],input[type=date],select,textarea,input[type=file], .flatpickr-input { width:100%; padding:12px 15px; margin-bottom:15px; border:1px solid #6a4f3a; border-radius:6px; background-color:#4a3f35; color:#f0e5d8; font-size:1em; box-sizing:border-box; transition:border-color .3s ease,box-shadow .3s ease; }
        input[type=date] { color-scheme: dark; } input.flatpickr-input { cursor: pointer; background-color:#4a3f35 !important; } input[type=date].flatpickr-hidden { display: none; }
        textarea{min-height:80px; line-height:1.5;} input[type=file]{color:#b0a095; padding:8px 10px} input[type=text]::placeholder,input[type=number]::placeholder,textarea::placeholder, input[type=date]::placeholder {color:#9a8f85;}
        input[type=text]:focus,input[type=number]:focus,input[type=date]:focus,select:focus,textarea:focus,input[type=file]:focus, .flatpickr-input:focus{ outline:none; border-color:#b08f5a; box-shadow:0 0 0 3px rgba(176, 143, 90, 0.3); } select{ appearance:none; background-image:url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23b0a095" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); background-repeat:no-repeat; background-position:right 15px center; background-size:16px 12px; padding-right:40px; } select option{background-color:#4a3f35; color:#f0e5d8;}
        button{display:inline-block; width:auto; min-width:120px; padding:12px 20px; color:#fff; border:none; border-radius:6px; font-size:1em; font-weight:600; cursor:pointer; transition:background-color .3s ease,transform .1s ease; margin-top:15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);}
        button.next-btn{background-color:#8a6f45; float:right} button.next-btn:hover{background-color:#a08f65;} button.next-btn:active{background-color:#7a5f35; transform:translateY(1px)}
        button.prev-btn{background-color:#6c5b4c; float:left} button.prev-btn:hover{background-color:#8a7b6c;} button.prev-btn:active{background-color:#5c4b3c; transform:translateY(1px)}
        button.start-over-btn{background-color:#6c5b4c; float:left} button.start-over-btn:hover{background-color:#8a7b6c;} button.start-over-btn:active{background-color:#5c4b3c; transform:translateY(1px)}
        #confirmPlanBtn{background-color:#6a8a45; float:right} #confirmPlanBtn:hover{background-color:#8aa065;} #confirmPlanBtn:active{background-color:#5a7a35; transform:translateY(1px)}
        #getLocationBtn{background-color:#5a7a9a; display:block; width:100%; margin-bottom:10px; float:none} #getLocationBtn:hover{background-color:#7a9ab0;} #getLocationBtn:disabled, button:disabled{background-color:#4a3f35; cursor:not-allowed; opacity:.7}
        .form-step{display:none; animation:fadeIn .5s ease-in-out; padding-bottom:20px}.form-step.active-step{display:block}.form-step::after{content:"";display:table;clear:both}.other-input-container{display:none;margin-top:15px;animation:fadeIn .4s ease}.food-step{}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}#locationStatus{padding:10px 15px;margin-bottom:15px;border-radius:5px;font-size:.95em;text-align:center;display:none;background-color:#4a3f35;border:1px solid #6a4f3a;color:#f0e5d8}#locationStatus.status-success{background-color:#5a7a35;border-color:#6a8a45;color:#fff}#locationStatus.status-error{background-color:#8a4f45;border-color:#a06f65;color:#fff}#locationStatus.visible{display:block}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(10,10,10,.8);display:none;justify-content:center;align-items:center;z-index:1000; backdrop-filter: blur(3px);}.modal-overlay.visible{display:flex}#confirmationModal{background-color:#3b2e26; padding:30px 40px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.5);width:90%;max-width:450px;text-align:center;border:1px solid #6a4f3a}#modalTitle{color:#f0e5d8;font-size:1.4em;margin-bottom:15px;font-weight:500}#modalMessage{color:#e0d5c8;margin-bottom:30px;line-height:1.6}#modalActions button{margin:0 10px;min-width:100px}#modalConfirmBtn{background-color:#a05f55;}#modalConfirmBtn:hover{background-color:#b07f75;}#modalConfirmBtn.ok-button{background-color:#8a6f45;}#modalConfirmBtn.ok-button:hover{background-color:#a08f65;}#modalCancelBtn{background-color:#6c5b4c;}#modalCancelBtn:hover{background-color:#8a7b6c;}#modalCancelBtn.hidden{display:none}
        .image-preview{ margin-top: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; min-height: 50px; background-color: rgba(74, 63, 53, 0.5); border: 1px dashed #6a4f3a; border-radius: 5px; padding: 10px; } .preview-item { position: relative; } .preview-item img { display: block; max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid #8a6f45; object-fit: cover; } .remove-img-btn { position: absolute; top: -5px; right: -5px; width: 22px; height: 22px; background-color: rgba(0, 0, 0, 0.6); color: #fff; border: 1px solid #fff; border-radius: 50%; font-size: 14px; line-height: 20px; text-align: center; font-weight: bold; cursor: pointer; padding: 0; min-width: auto; margin: 0; } .remove-img-btn:hover { background-color: rgba(200, 50, 50, 0.8); }
        .suggestions-container { position: relative; margin-bottom: 15px; } .suggestions-list { position: absolute; top: calc(100% - 15px); left: 0; right: 0; background-color: #4a3f35; border: 1px solid #b08f5a; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 999; box-sizing: border-box; display: none; } .suggestions-list.visible { display: block; } .suggestion-item { padding: 10px 15px; color: #f0e5d8; cursor: pointer; border-bottom: 1px solid #6a4f3a; } .suggestion-item:last-child { border-bottom: none; } .suggestion-item:hover { background-color: #6a4f3a; }
        #summaryContent { text-align: left; margin-top: 20px; padding: 15px; background-color: rgba(74, 63, 53, 0.3); border-radius: 6px; border: 1px solid #6a4f3a;} #summaryContent p { margin-bottom: 12px; line-height: 1.6; } #summaryContent strong { color: #b0a095; display: inline-block; min-width: 150px; padding-right: 10px; font-weight: 600;} #summaryContent ul { list-style: none; padding-left: 25px; margin-top: 6px; } #summaryContent li { margin-bottom: 6px; }
        @media (max-width:650px){body{padding:10px}#eventForm{padding:20px}h1{font-size:1.8em}h2{font-size:1.3em}#getLocationBtn{margin-bottom:15px}button.next-btn,button#confirmPlanBtn{width:48%;float:right;margin-left:2%}button.prev-btn, button.start-over-btn{width:48%;float:left;margin-right:2%}} @media (max-width:420px){#getLocationBtn{margin-bottom:10px}button.next-btn,button#confirmPlanBtn,button.prev-btn,button.start-over-btn{width:100%;float:none;margin-left:0;margin-right:0;margin-bottom:10px}}
        .flatpickr-calendar { z-index: 1001 !important; }
        #eventForm::before { content: ''; position: absolute; width: 10px; height: 10px; background: radial-gradient(ellipse at center, #ffffff 0%, #f0e5d8 50%, rgba(240, 229, 216, 0) 70%); border-radius: 50%; box-shadow: 0 0 6px 2px #fff; animation: marquee-light 8s linear infinite; top: -5px; left: -5px; }
        @keyframes marquee-light { 0% { top: -5px; left: -5px; } 25% { top: -5px; left: calc(100% - 5px); } 50% { top: calc(100% - 5px); left: calc(100% - 5px); } 75% { top: calc(100% - 5px); left: -5px; } 100% { top: -5px; left: -5px; } }

        /* --- Button Styles --- */
        #logoutBtn, #authBtn {
            position: fixed;
            top: 20px;
            padding: 10px 20px;
            color: #f0e5d8;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        #authBtn { right: 20px; background: linear-gradient(135deg, #8a6f45 0%, #6a4f3a 100%); }
        #authBtn:hover { background: linear-gradient(135deg, #9a7f55 0%, #7a5f4a 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        #authBtn:active { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #logoutBtn { right: 20px; background: linear-gradient(135deg, #8a6f45 0%, #6a4f3a 100%); }
        #logoutBtn:hover { background: linear-gradient(135deg, #9a7f55 0%, #7a5f4a 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        #logoutBtn:active { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    </style>
</head>
<body>
    <button id="logoutBtn" style="display: none;">Logout</button>
    <button id="authBtn" style="display: none;">Sign In</button>

    <form id="eventForm" novalidate method="post">
        <div class="form-step active-step" data-step="1">
            <h2>About You</h2>
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" required>
            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" required>
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" min="1" required>
            <button type="button" class="next-btn">Next</button>
        </div>

        <div class="form-step" data-step="2"> <h2>Event Nickname</h2> <label for="projectName">Give your event plan a name:</label> <input type="text" id="projectName" name="projectName" placeholder="e.g., Sarah's 30th Birthday Bash" required> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="3"> <h2>When Is It?</h2> <label for="eventStartDateTime">Event Start Date & Time:</label> <input type="date" id="eventStartDateTime" name="eventStartDateTime" placeholder="Select start date and time..." required> <label for="eventDuration">Approximate Duration:</label> <select id="eventDuration" name="eventDuration" required> <option value="" disabled selected>-- Select Duration --</option> <option value="1h">1 Hour</option> <option value="2h">2 Hours</option> <option value="3h">3 Hours</option> <option value="4h">4 Hours</option> <option value="6h">6 Hours</option> <option value="8h">8 Hours</option> <option value="12h">~ Half Day (12 Hours)</option> <option value="24h">~ Full Day / Overnight (24+ Hours)</option> <option value="Other">Other (Specify Below)</option> </select> <div class="other-input-container" id="customDurationContainer"> <label for="customDuration">Specify Duration Details:</label> <input type="text" id="customDuration" name="customDuration" placeholder="e.g., 2.5 hours, All evening, Full weekend"> </div> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="4"> <h2>Whereabouts</h2> <div id="locationStatus"></div> <button type="button" id="getLocationBtn">Use My Current Location</button> <div class="suggestions-container"> <label for="city">City:</label> <input type="text" id="city" name="city" required autocomplete="off"> <div id="citySuggestions" class="suggestions-list"></div> </div> <label for="country">Country:</label> <input type="text" id="country" name="country" required> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="5"> <h2>What Kind of Party?</h2> <label for="eventType">Select the type of event:</label> <select id="eventType" name="eventType" required> <option value="" disabled selected>-- Select Type --</option> <option value="Wedding">Wedding</option> <option value="Birthday Party">Birthday Party</option> <option value="Corporate Event">Corporate Event</option> <option value="Festival">Festival</option> <option value="Conference">Conference</option> <option value="Workshop">Workshop</option> <option value="Baby Shower">Baby Shower</option> <option value="Anniversary">Anniversary</option> <option value="Other">Other</option> </select> <div class="other-input-container" id="otherEventTypeContainer"> <label for="otherEventType">Please specify:</label> <input type="text" id="otherEventType" name="otherEventType" placeholder="Specify event type"> </div> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="6"> <h2>The Vibe</h2> <label for="eventStyle">Select the style/theme:</label> <select id="eventStyle" name="eventStyle" required> <option value="" disabled selected>-- Select Style --</option> <option value="Elegant & Formal">Elegant & Formal</option> <option value="Rustic & Bohemian">Rustic & Bohemian</option> <option value="Modern & Minimalist">Modern & Minimalist</option> <option value="Vintage & Retro">Vintage & Retro</option> <option value="Tropical & Beachy">Tropical & Beachy</option> <option value="Glamorous & Chic">Glamorous & Chic</option> <option value="Fun & Casual">Fun & Casual</option> <option value="Themed">Themed</option> <option value="Other">Other</option> </select> <div class="other-input-container" id="otherEventStyleContainer"> <label for="otherEventStyle">Please specify:</label> <input type="text" id="otherEventStyle" name="otherEventStyle" placeholder="Specify style/theme"> </div> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="7"> <h2>Headcount</h2> <label for="numPeople">Approximate number of people attending:</label> <input type="number" id="numPeople" name="numPeople" min="1" placeholder="e.g., 50" required> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="8"> <h2>Food Time?</h2> <label>Is catering/food required for this event?</label> <div class="radio-group"> <label><input type="radio" id="foodNeededYes" name="foodNeeded" value="yes" required> Yes</label> <label><input type="radio" id="foodNeededNo" name="foodNeeded" value="no" required> No</label> </div> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step food-step" data-step="9"> <h2>Serving Style</h2> <label for="foodStyle">Select the desired food service style:</label> <select id="foodStyle" name="foodStyle" required> <option value="" disabled selected>-- Select Style --</option> <option value="Buffet">Buffet</option> <option value="Plated Dinner">Plated Dinner (Sit-down)</option> <option value="Food Stations">Food Stations</option> <option value="Family Style">Family Style</option> <option value="Cocktail Reception">Cocktail Reception (Appetizers/Hors d'oeuvres)</option> <option value="Food Trucks">Food Trucks</option> <option value="Dessert Only">Dessert Only</option> <option value="Other">Other</option> </select> <div class="other-input-container" id="otherFoodStyleContainer"> <label for="otherFoodStyle">Please specify:</label> <input type="text" id="otherFoodStyle" name="otherFoodStyle" placeholder="Specify food style"> </div> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step food-step" data-step="10"> <h2>Food Funds</h2> <label for="foodBudgetPerPerson">Approximate food budget per person (USD):</label> <input type="number" id="foodBudgetPerPerson" name="foodBudgetPerPerson" min="0" placeholder="e.g., 75" required step="any"> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="11"> <h2>Total Budget</h2> <label for="budget">Approximate total budget for the event (USD):</label> <input type="number" id="budget" name="budget" min="0" placeholder="e.g., 10000" required step="any"> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="12"> <h2>Mood Board</h2> <div id="inspirationUploadContainer"> <label for="inspirationPhotos">Upload Inspiration Photo (Max 1):</label> <input type="file" id="inspirationPhotos" name="inspirationPhotos" accept="image/*"> </div> <div class="image-preview" id="inspirationPreview"></div> <label for="inspirationNotes">Inspiration Notes:</label> <textarea id="inspirationNotes" name="inspirationNotes" rows="4" placeholder="Describe your vision, link to Pinterest boards, etc..."></textarea> <button type="button" class="prev-btn">Previous</button> <button type="button" class="next-btn">Next</button> </div>
        <div class="form-step" data-step="13"> <h2>The Grand Plan!</h2> <p>Please review your event details below. If everything looks good, hit Confirm!</p> <div id="summaryContent"> Loading summary... </div> <button type="button" class="prev-btn">Previous</button> <button type="submit" id="confirmPlanBtn">Confirm Plan</button> </div>

    </form>

    <div class="modal-overlay" id="modalOverlay">
        <div id="confirmationModal">
            <h3 id="modalTitle">Confirmation</h3>
            <p id="modalMessage">Are you sure?</p>
            <div id="modalActions">
                <button id="modalCancelBtn">Cancel</button>
                <button id="modalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script>
        // --- Firebase Initialization (Ensure this happens only ONCE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAU3qmsD15JX6iwjloTjCPDd-2SuG6oM8w",
            authDomain: "chokaj-4dcae.firebaseapp.com",
            projectId: "chokaj-4dcae",
            storageBucket: "chokaj-4dcae.firebasestorage.app",
            messagingSenderId: "516228224797",
            appId: "1:516228224797:web:6bdf08edb5962aad5633f4",
            measurementId: "G-9QVCF19J2W"
        };
        if (!firebase.apps.length) {
             firebase.initializeApp(firebaseConfig);
             console.log('Firebase Initialized.');
        } else {
             firebase.app();
             console.log('Firebase already initialized.');
        }
        const auth = firebase.auth();

        console.log('Index.html: Initializing auth state check...');

        // --- Basic Auth Button Visibility Logic ---
        auth.onAuthStateChanged((user) => {
            console.log('Index.html: Auth state received:', user ? `User ${user.uid}` : 'No user');
            const authBtn = document.getElementById('authBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            // No loading indicator or form hiding needed in this version

            if (user) {
                // User is signed in
                console.log('Index.html: User is signed in, showing logout button');
                if (authBtn) authBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';
            } else {
                // User is signed out
                console.log('Index.html: User is signed out, showing sign in button');
                if (authBtn) authBtn.style.display = 'block';
                if (logoutBtn) logoutBtn.style.display = 'none';
                // NO AUTOMATIC REDIRECT HERE
            }
        });

        // --- Button Listeners (Attached after DOM ready) ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Logout Button Listener ---
             const logoutBtnRef = document.getElementById('logoutBtn');
             if (logoutBtnRef) {
                 logoutBtnRef.addEventListener('click', async () => {
                    console.log('Logout button clicked...');
                    try {
                        await auth.signOut();
                        console.log('Sign out successful. Auth listener will update buttons.');
                        // No redirect needed, onAuthStateChanged handles button swap
                    } catch (error) {
                        console.error('Error signing out:', error);
                        alert('Error signing out. Please try again.');
                    }
                 });
             } else {
                 console.error("Logout button not found for listener attachment.");
             }

            // --- Sign In Button Listener --- (Redirects ONLY on click)
             const authBtnRef = document.getElementById('authBtn');
             if (authBtnRef) {
                 authBtnRef.addEventListener('click', () => {
                     console.log('Auth button (Sign In) clicked, redirecting to login...');
                     window.location.replace('login.html'); // Use replace
                 });
             } else {
                  console.error("Auth button (Sign In) not found for listener attachment.");
             }

             // --- Admin Keyboard Shortcut Listener REMOVED ---

        }); // End DOMContentLoaded for listeners
    </script>

    <script>
        // Wrap entire script in a try...catch
        try {
            document.addEventListener('DOMContentLoaded', () => {
                // This form logic runs regardless of login state in this version,
                // as the form is always potentially visible.
                console.log("DOM fully loaded. Initializing form script...");
                const formElement = document.getElementById('eventForm');
                if (formElement) {
                    // --- Element References ---
                    const steps = Array.from(formElement.querySelectorAll('.form-step')); const TOTAL_STEPS = steps.length;
                    const submitButton = document.getElementById('confirmPlanBtn');
                    const getLocationButton = document.getElementById('getLocationBtn');
                    const cityInput = document.getElementById('city');
                    const countryInput = document.getElementById('country');
                    const eventTypeSelect = document.getElementById('eventType');
                    const otherEventTypeContainer = document.getElementById('otherEventTypeContainer');
                    const otherEventTypeInput = document.getElementById('otherEventType');
                    const eventStyleSelect = document.getElementById('eventStyle');
                    const otherEventStyleContainer = document.getElementById('otherEventStyleContainer');
                    const otherEventStyleInput = document.getElementById('otherEventStyle');
                    const foodStyleSelect = document.getElementById('foodStyle');
                    const otherFoodStyleContainer = document.getElementById('otherFoodStyleContainer');
                    const otherFoodStyleInput = document.getElementById('otherFoodStyle');
                    const modalOverlay = document.getElementById('modalOverlay');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalMessage = document.getElementById('modalMessage');
                    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
                    const modalCancelBtn = document.getElementById('modalCancelBtn');
                    const locationStatusArea = document.getElementById('locationStatus');
                    const inspirationPhotosInput = document.getElementById('inspirationPhotos');
                    const inspirationPreview = document.getElementById('inspirationPreview');
                    const inspirationNotesInput = document.getElementById('inspirationNotes');
                    const citySuggestionsContainer = document.getElementById('citySuggestions');
                    const eventDateInput = document.getElementById('eventStartDateTime');
                    const eventDurationSelect = document.getElementById('eventDuration');
                    const customDurationContainer = document.getElementById('customDurationContainer');
                    const customDurationInput = document.getElementById('customDuration');
                    const summaryContentDiv = document.getElementById('summaryContent');
                    const inspirationUploadContainer = document.getElementById('inspirationUploadContainer');

                    // --- State Variables ---
                    let currentStep = 1;
                    const initialFormData = { firstName: '', lastName: '', age: null, projectName: '', eventStartDateTime: null, eventDuration: '', customDuration: '', city: '', country: '', eventType: '', otherEventType: '', eventStyle: '', otherEventStyle: '', numPeople: null, foodNeeded: null, foodStyle: '', otherFoodStyle: '', foodBudgetPerPerson: null, budget: null, inspirationNotes: '', inspirationPhotosInfo: [] };
                    let formData = { ...initialFormData };
                    const foodSteps = [9, 10];
                    let selectedInspirationFiles = [];
                    let confirmCallback = null;
                    let statusTimeout = null;
                    let debounceTimer = null;
                    const MAX_INSPIRATION_FILES = 1;
                    let isModalCurrentlyVisible = false;

                    // --- Helper Functions ---
                    const formatDateField = (date) => { if (!date) return null; return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
                    const formatTimeField = (date) => { if (!date) return null; const hours = date.getHours(); const minutes = String(date.getMinutes()).padStart(2, '0'); const ampm = hours >= 12 ? 'PM' : 'AM'; const hours12 = hours % 12 || 12; return `${String(hours12).padStart(2, '0')}:${minutes} ${ampm}`; }

                    // --- Flatpickr Initialization ---
                    if (eventDateInput && typeof flatpickr === 'function') { flatpickr(eventDateInput, { enableTime: true, dateFormat: "Y-m-d H:i", altInput: true, altFormat: "M j, Y h:i K", minDate: "today", minuteIncrement: 15, time_24hr: false, theme: "dark", onChange: function(selectedDates, dateStr, instance) { if (selectedDates.length > 0) { formData.eventStartDateTime = dateStr; } else { formData.eventStartDateTime = null; } }, onReady: function(selectedDates, dateStr, instance) { if (instance.input.value && !formData.eventStartDateTime) { formData.eventStartDateTime = instance.input.value; } } }); }

                    // --- Core Form Functions ---
                    const showStep = (stepNumber) => { if (stepNumber < 1 || stepNumber > TOTAL_STEPS) return; if (formData.foodNeeded === 'no' && foodSteps.includes(stepNumber)) { let nextStepNum = stepNumber; while (foodSteps.includes(nextStepNum)) { nextStepNum++; } stepNumber = nextStepNum; if (stepNumber > TOTAL_STEPS) stepNumber = TOTAL_STEPS; } steps.forEach((step) => step.classList.remove('active-step')); const targetStepElement = steps.find(step => parseInt(step.dataset.step, 10) === stepNumber); if (targetStepElement) { targetStepElement.classList.add('active-step'); currentStep = stepNumber; const firstInput = targetStepElement.querySelector('input:not([type="radio"]):not([type="file"]):not([type="checkbox"]), select, textarea'); if (firstInput && firstInput.id !== 'eventStartDateTime') setTimeout(() => { try { firstInput.focus(); } catch(e){} }, 50); else { const firstRadio = targetStepElement.querySelector('input[type="radio"]'); if (firstRadio) setTimeout(() => { try { firstRadio.focus(); } catch(e){} }, 50); } } else { showStep(1); } };
                    const collectStepData = (stepNumToCollect) => { try { switch (stepNumToCollect) { case 1: formData.firstName = document.getElementById('firstName')?.value.trim() ?? ''; formData.lastName = document.getElementById('lastName')?.value.trim() ?? ''; const ageInput = document.getElementById('age'); formData.age = ageInput?.value ? parseInt(ageInput.value, 10) : null; break; case 2: formData.projectName = document.getElementById('projectName')?.value.trim() ?? ''; break; case 3: formData.eventDuration = eventDurationSelect?.value ?? ''; formData.customDuration = (formData.eventDuration === 'Other') ? customDurationInput?.value.trim() ?? '' : ''; break; case 4: formData.city = cityInput?.value.trim() ?? ''; formData.country = countryInput?.value.trim() ?? ''; break; case 5: formData.eventType = eventTypeSelect?.value ?? ''; formData.otherEventType = (formData.eventType === 'Other') ? otherEventTypeInput?.value.trim() ?? '' : ''; break; case 6: formData.eventStyle = eventStyleSelect?.value ?? ''; formData.otherEventStyle = (formData.eventStyle === 'Other') ? otherEventStyleInput?.value.trim() ?? '' : ''; break; case 7: const np = document.getElementById('numPeople'); formData.numPeople = np?.value ? parseInt(np.value, 10) : null; break; case 8: const sr = formElement.querySelector('input[name="foodNeeded"]:checked'); formData.foodNeeded = sr ? sr.value : null; if (formData.foodNeeded === 'no') { formData.foodStyle = ''; formData.otherFoodStyle = ''; formData.foodBudgetPerPerson = null; if(foodStyleSelect) foodStyleSelect.value = ''; if(otherFoodStyleInput) otherFoodStyleInput.value = ''; const foodBudgetInput = document.getElementById('foodBudgetPerPerson'); if(foodBudgetInput) foodBudgetInput.value = ''; handleOtherOption(foodStyleSelect, otherFoodStyleContainer); } break; case 9: if (formData.foodNeeded === 'yes') { formData.foodStyle = foodStyleSelect?.value ?? ''; formData.otherFoodStyle = (formData.foodStyle === 'Other') ? otherFoodStyleInput?.value.trim() ?? '' : ''; } break; case 10: if (formData.foodNeeded === 'yes') { const fb = document.getElementById('foodBudgetPerPerson'); formData.foodBudgetPerPerson = fb?.value ? parseFloat(fb.value) : null; } break; case 11: const b = document.getElementById('budget'); formData.budget = b?.value ? parseFloat(b.value) : null; break; case 12: formData.inspirationNotes = inspirationNotesInput?.value.trim() ?? ''; formData.inspirationPhotosInfo = selectedInspirationFiles.map(f => ({ name: f.name, size: f.size, type: f.type })); break; } } catch (error) { console.error(`Error collecting data step ${stepNumToCollect}:`, error); } };
                    const handleOtherOption = (selectElement, containerElement) => { if(selectElement && containerElement) { containerElement.style.display = (selectElement.value === 'Other') ? 'block' : 'none'; const customInput = containerElement.querySelector('input, textarea'); if (customInput) { customInput.required = (selectElement.value === 'Other'); } } };
                    const showLocationStatus = (message, type = 'info', duration = 4000) => { if (!locationStatusArea) return; clearTimeout(statusTimeout); locationStatusArea.textContent = message; locationStatusArea.className = `status-${type}`; locationStatusArea.classList.add('visible'); if (duration !== null) { statusTimeout = setTimeout(() => { locationStatusArea.classList.remove('visible'); }, duration); } };
                    const hideLocationStatus = () => { if (locationStatusArea) { clearTimeout(statusTimeout); locationStatusArea.classList.remove('visible'); } };
                    const handleGetLocation = async () => { console.log("Attempting to get location..."); if (!navigator.geolocation) { showLocationStatus('Geolocation is not supported by browser.', 'error'); return; } if (getLocationButton) { getLocationButton.disabled = true; getLocationButton.textContent = 'Getting Location...'; } showLocationStatus('Fetching coordinates...', 'info', null); try { const position = await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }); }); const { latitude, longitude } = position.coords; showLocationStatus('Coordinates found. Fetching address from OSM...', 'info', null); const reverseGeocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`; const response = await fetch(reverseGeocodeUrl, { headers: { 'Accept-Language': 'en' } }); if (!response.ok) { throw new Error(`OSM API Error: ${response.status} ${response.statusText}`); } const data = await response.json(); if (data && data.address) { const addr = data.address; const city = addr.city || addr.town || addr.village || addr.county || ''; const country = addr.country || ''; if (city && country) { if(cityInput) cityInput.value = city; if(countryInput) countryInput.value = country; formData.city = city; formData.country = country; showLocationStatus('Location populated!', 'success', 4000); } else { showLocationStatus('Could not determine city/country from location.', 'error', 5000); } } else { showLocationStatus('Address not found in location data.', 'error', 5000); } } catch (error) { console.error("Error during location fetching:", error); let message = 'Could not get location.'; if (error.code) { switch (error.code) { case error.PERMISSION_DENIED: message = "Location access denied."; break; case error.POSITION_UNAVAILABLE: message = "Location information unavailable."; break; case error.TIMEOUT: message = "Location request timed out."; break; } } else { message = `Error: ${error.message}`; } showLocationStatus(message, 'error', 6000); } finally { if (getLocationButton) { getLocationButton.disabled = false; getLocationButton.textContent = 'Use My Current Location'; } } };
                    const renderImagePreviews = () => { if (!inspirationPreview) return; inspirationPreview.innerHTML = ''; selectedInspirationFiles.forEach((fileInfo, index) => { const previewItem = document.createElement('div'); previewItem.classList.add('preview-item'); const img = document.createElement('img'); img.alt = fileInfo.name; img.title = `${fileInfo.name} (${(fileInfo.size / 1024).toFixed(1)} KB)`; const reader = new FileReader(); reader.onload = (loadEvent) => { img.src = loadEvent.target.result; }; reader.onerror = () => { img.alt = "Preview Error"; }; reader.readAsDataURL(fileInfo.fileRef); const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.classList.add('remove-img-btn'); removeBtn.textContent = 'Ã—'; removeBtn.dataset.index = index; removeBtn.addEventListener('click', handleRemoveImage); previewItem.appendChild(img); previewItem.appendChild(removeBtn); inspirationPreview.appendChild(previewItem); }); };
                    const handleRemoveImage = (event) => { const indexToRemove = parseInt(event.target.dataset.index, 10); if (!isNaN(indexToRemove) && indexToRemove >= 0 && indexToRemove < selectedInspirationFiles.length) { selectedInspirationFiles.splice(indexToRemove, 1); renderImagePreviews(); if (inspirationUploadContainer && selectedInspirationFiles.length < MAX_INSPIRATION_FILES) { inspirationUploadContainer.style.display = 'block'; } } };
                    const handleFileSelect = (event) => { const files = event.target.files; if (!files || files.length === 0) return; const currentCount = selectedInspirationFiles.length; const availableSlots = MAX_INSPIRATION_FILES - currentCount; if (availableSlots <= 0) { showInfoModalWithFlag("Limit Reached", `Max ${MAX_INSPIRATION_FILES} image allowed.`); if(inspirationPhotosInput) inspirationPhotosInput.value = null; return; } const fileToAdd = files[0]; if (files.length > 1) { showInfoModalWithFlag("Limit is 1", `You selected multiple files, but only the first one (${fileToAdd.name}) can be added.`); } if (!fileToAdd.type.startsWith('image/')){ showInfoModalWithFlag("Invalid File", "Please select an image file."); if(inspirationPhotosInput) inspirationPhotosInput.value = null; return; } selectedInspirationFiles.push({ fileRef: fileToAdd, name: fileToAdd.name, size: fileToAdd.size, type: fileToAdd.type }); renderImagePreviews(); if (inspirationUploadContainer && selectedInspirationFiles.length >= MAX_INSPIRATION_FILES) { inspirationUploadContainer.style.display = 'none'; } if(inspirationPhotosInput) inspirationPhotosInput.value = null; };
                    function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };
                    const fetchSuggestions = async (query) => { if (!query || query.length < 3) { displaySuggestions([]); return; } const apiUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=jsonv2&featuretype=city&addressdetails=1&limit=5`; try { const response = await fetch(apiUrl, { headers: { 'Accept-Language': 'en' } }); if (!response.ok) { throw new Error(`OSM Suggestion API Error: ${response.status} ${response.statusText}`); } const data = await response.json(); displaySuggestions(data); } catch (error) { console.error('City suggestion fetch error:', error); displaySuggestions([]); } };
                    const displaySuggestions = (suggestionsData) => { if (!citySuggestionsContainer || !cityInput || !countryInput) return; citySuggestionsContainer.innerHTML = ''; if (!suggestionsData || suggestionsData.length === 0) { citySuggestionsContainer.classList.remove('visible'); return; } suggestionsData.forEach(place => { const suggestionDiv = document.createElement('div'); suggestionDiv.classList.add('suggestion-item'); suggestionDiv.textContent = place.display_name || 'Unknown Place'; const address = place.address || {}; const city = address.city || address.town || address.village || address.county || ''; const country = address.country || ''; suggestionDiv.addEventListener('click', () => { cityInput.value = city || place.display_name.split(',')[0].trim(); countryInput.value = country; formData.city = cityInput.value; formData.country = countryInput.value; citySuggestionsContainer.classList.remove('visible'); citySuggestionsContainer.innerHTML = ''; }); citySuggestionsContainer.appendChild(suggestionDiv); }); citySuggestionsContainer.classList.add('visible'); };
                    const debouncedFetch = debounce(fetchSuggestions, 400);
                    const showModalBase = (makeVisible) => { if (!modalOverlay) return false; if (makeVisible) { modalOverlay.classList.add('visible'); isModalCurrentlyVisible = true; } else { modalOverlay.classList.remove('visible'); isModalCurrentlyVisible = false; } return true; };
                    const showInfoModalWithFlag = (title, message) => { if (!showModalBase(true)) { alert(`Info: ${title}\n\n${message}`); return; } if (!modalTitle || !modalMessage || !modalConfirmBtn || !modalCancelBtn) { hideModalWithFlag(); return; } modalTitle.textContent = title; modalMessage.innerHTML = message; confirmCallback = null; modalConfirmBtn.textContent = "OK"; modalConfirmBtn.classList.add('ok-button'); modalCancelBtn.classList.add('hidden'); };
                    const showModalWithFlag = (title, message, onConfirm) => { if (!showModalBase(true)) { if (confirm(`Modal Error. Proceed anyway? (${title})`)) if(typeof onConfirm === 'function') onConfirm(); return; } if (!modalTitle || !modalMessage || !modalConfirmBtn || !modalCancelBtn) { hideModalWithFlag(); return; } modalTitle.textContent = title; modalMessage.innerHTML = message; confirmCallback = onConfirm; modalConfirmBtn.textContent = "Confirm"; modalConfirmBtn.classList.remove('ok-button'); modalCancelBtn.classList.remove('hidden'); };
                    const hideModalWithFlag = () => { showModalBase(false); const wasInfoModal = modalConfirmBtn && modalConfirmBtn.classList.contains('ok-button'); confirmCallback = null; if (modalCancelBtn) modalCancelBtn.classList.remove('hidden'); if (modalConfirmBtn) { modalConfirmBtn.textContent = "Confirm"; modalConfirmBtn.classList.remove('ok-button'); } if (wasInfoModal) { const activeElement=document.querySelector('.form-step.active-step'); if(activeElement){const firstInput=activeElement.querySelector('input:not([type="radio"]):not([type="file"]):not([type="checkbox"]), select, textarea');if(firstInput&&firstInput.id!=='eventStartDateTime'){setTimeout(()=>{try{firstInput.focus();}catch(e){}},0);}} } };
                    const validateStepWithFlag = (stepNumToValidate) => { if (stepNumToValidate >= 12 && stepNumToValidate !== 11) return true; let message = ''; collectStepData(stepNumToValidate); switch (stepNumToValidate) { case 1: if (!formData.firstName) message="Please enter first name."; else if (!formData.lastName) message="Please enter last name."; else if (formData.age === null || isNaN(formData.age) || formData.age < 1) message="Invalid age."; break; case 2: if (!formData.projectName) message="Please enter event name."; break; case 3: if (!formData.eventStartDateTime) message="Please select a start date and time."; else if (!formData.eventDuration) message="Please select an approximate duration."; else if (formData.eventDuration === 'Other' && !formData.customDuration) message="Please specify the custom duration."; break; case 4: if (!formData.city) message="Please enter city."; else if (!formData.country) message="Please enter country."; break; case 5: if (!formData.eventType) message="Select event type."; else if (formData.eventType === 'Other' && !formData.otherEventType) message="Specify event type."; break; case 6: if (!formData.eventStyle) message="Select event style."; else if (formData.eventStyle === 'Other' && !formData.otherEventStyle) message="Specify event style."; break; case 7: if (formData.numPeople === null || isNaN(formData.numPeople) || formData.numPeople < 1) message="Invalid number of guests."; break; case 8: if (formData.foodNeeded === null) message="Specify if food needed."; break; case 9: if (formData.foodNeeded === 'yes' && !formData.foodStyle) message="Select food style."; else if (formData.foodNeeded === 'yes' && formData.foodStyle === 'Other' && !formData.otherFoodStyle) message="Specify food style."; break; case 10: if (formData.foodNeeded === 'yes' && (formData.foodBudgetPerPerson === null || isNaN(formData.foodBudgetPerPerson) || formData.foodBudgetPerPerson < 0)) message="Invalid food budget."; break; case 11: if (formData.budget === null || isNaN(formData.budget) || formData.budget < 0) message="Invalid total budget."; break; } if (message) { showInfoModalWithFlag("Missing/Invalid Data", message); return false; } return true; };
                    function generateAiPrompts(data) { try { const formatString = (value, fallback = 'Not specified') => value || fallback; const formatCurrency = (value) => value !== null && !isNaN(value) ? `$${parseFloat(value).toLocaleString()}` : 'Not specified'; const hasInspirationPhoto = data.inspirationPhotosInfo && data.inspirationPhotosInfo.length > 0; const matchedVenueName = "[Selected Venue Name Placeholder]"; const matchedVenueCapacity = "[Selected Venue Capacity Placeholder]"; const matchedVendorName = "[Selected Vendor Name Placeholder]"; const matchedVendorType = "[Selected Vendor Type Placeholder]"; const matchedVendorDetail = "[Selected Vendor Detail Placeholder]"; const guests = data.numPeople || 0; const tablesEstimate = guests > 0 ? `approx ${Math.ceil(guests / 8)}-${Math.ceil(guests / 6)} tables` : 'tables appropriate for guest count'; let durationStr = 'Not specified'; if (data.eventDuration) { if (data.eventDuration === 'Other') { durationStr = formatString(data.customDuration, '(Custom duration not specified)'); } else { const durationOptions = { '1h': '1 Hour', '2h': '2 Hours', '3h': '3 Hours', '4h': '4 Hours', '6h': '6 Hours', '8h': '8 Hours', '12h': '~ Half Day (12 Hours)', '24h': '~ Full Day / Overnight (24+ Hours)' }; durationStr = durationOptions[data.eventDuration] || data.eventDuration; } } let prompt = `**AI Task: Event Plan Analysis and Visualization**\n\n`; prompt += `**Input Data:**\n`; prompt += `* Event Name: ${formatString(data.projectName)}\n`; prompt += `* Event Type: ${formatString(data.eventType)}${(data.eventType === 'Other' && data.otherEventType) ? ` (Specified as: ${data.otherEventType})` : ''}\n`; prompt += `* Style/Theme: ${formatString(data.eventStyle)}${(data.eventStyle === 'Other' && data.otherEventStyle) ? ` (Specified as: ${data.otherEventStyle})` : ''}\n`; prompt += `* Location Context: ${formatString(data.city)}, ${formatString(data.country)}\n`; prompt += `* Guest Count: Approx. ${formatString(data.numPeople)}\n`; prompt += `* Event Start: ${formatString(data.eventStartDateTime)}\n`; prompt += `* Event Duration: ${durationStr}\n`; prompt += `* Food Required: ${formatString(data.foodNeeded)}\n`; if (data.foodNeeded === 'yes') { prompt += `    * Food Service Style: ${formatString(data.foodStyle)}${(data.foodStyle === 'Other' && data.otherFoodStyle) ? ` (Specified as: ${data.otherFoodStyle})` : ''}\n`; prompt += `    * Food Budget/Person: ${formatCurrency(data.foodBudgetPerPerson)}\n`; } prompt += `* Total Budget Context: ${formatCurrency(data.budget)}\n`; prompt += `* User Notes: "${formatString(data.inspirationNotes)}"\n`; prompt += `* Inspiration Image Provided: ${hasInspirationPhoto ? 'Yes' : 'No'}\n\n`; prompt += `**Instructions:**\n\n`; prompt += `1.  **Analyze & Match (Simulated Database Query):** Based on the input data (especially location, event type, guest count, style, food needs), identify the most suitable generic venue type (e.g., "Outdoor Yard", "Modern Loft", "Banquet Hall" - use ${matchedVenueName} as a placeholder) and food vendor type if food is required (e.g., "${matchedVendorType}" like "Taco Food Truck", "Buffet Catering Service" - use ${matchedVendorName} offering ${matchedVendorDetail} as placeholders) that would typically be found in our database for this request.\n\n`; prompt += `2.  **Generate Descriptive Text:** Create a short paragraph recommending the '${matchedVenueName}' and '${matchedVendorName}' (if applicable). Explain how their general characteristics (like typical capacity: ${matchedVenueCapacity}) align with the user's request (${formatString(data.numPeople)} guests, ${formatString(data.eventType)}, food needs) and how they can be adapted to fit the '${formatString(data.eventStyle)}' theme. Mention how the user's notes and inspiration image (if provided) can guide the final realization.\n\n`; prompt += `3.  **Generate Visualization (Image Prompt Details):** Create a single, detailed, photorealistic image based on the following:\n`; prompt += `    * **Setting:** Visualize the primary functional area of the '${matchedVenueName}' representing a suitable venue in ${formatString(data.city)}.\n`; prompt += `    * **Theme:** Apply the '${formatString(data.eventStyle)}' theme strongly to all decor (colors, lighting, furniture, table settings, floral arrangements, etc.).\n`; prompt += `    * **Scale:** Show table arrangements suitable for approximately ${formatString(data.numPeople)} guests (${tablesEstimate}).\n`; if (data.foodNeeded === 'yes') { prompt += `    * **Food Service:** Include a visual representation of the '${formatString(data.foodStyle)}' setup (e.g., if 'Food Trucks', show '${matchedVendorName}' parked attractively nearby; if 'Buffet', show elegant buffet lines; if 'Plated Dinner', show served dishes on tables).\n`; } else { prompt += `    * **Food Service:** Show tables set for dining without specific food service visible.\n`; } if (hasInspirationPhoto) { prompt += `    * **Style Guidance:** Heavily reference the style, color palette, and mood of the user-provided inspiration image.\n`; } else { prompt += `    * **Style Guidance:** Generate based on typical interpretations of the '${formatString(data.eventStyle)}' theme.\n`; } prompt += `    * **Atmosphere:** Focus on creating a compelling and appropriate atmosphere for the ${formatString(data.eventType)}.\n`; prompt += `    * **Negative Prompts:** Ensure the image avoids: blurry elements, visible text/words/logos, watermarks, low quality rendering, cartoon/illustration styles (unless specified by theme), visible people (focus on the setup).\n\n`; prompt += `**Output:** Provide the descriptive text (from step 2) and the generated image URL (based on step 3 instructions).`; return prompt; } catch (genError) { console.error("Error occurred *inside* generateAiPrompts:", genError); throw genError; } }
                    const generateSummary = () => { if (!summaryContentDiv) return; collectStepData(12); const formatCurrency = (value) => value !== null && !isNaN(value) ? `$${parseFloat(value).toLocaleString()}` : 'Not Set'; const formatString = (value, fallback = 'Not Set') => value || fallback; const formatAge = (value) => value !== null && !isNaN(value) ? value : 'N/A'; const hasInspirationPhoto = formData.inspirationPhotosInfo && formData.inspirationPhotosInfo.length > 0; let startDateTimeStr = 'Not Set'; if (eventDateInput && eventDateInput._flatpickr && eventDateInput._flatpickr.altInput) { startDateTimeStr = eventDateInput._flatpickr.altInput.value; } else if (formData.eventStartDateTime) { startDateTimeStr = formData.eventStartDateTime; } let durationStr = 'Not Set'; if (formData.eventDuration) { if (formData.eventDuration === 'Other') { durationStr = formatString(formData.customDuration, '(Custom duration not specified)'); } else { const selectedOption = eventDurationSelect.querySelector(`option[value="${formData.eventDuration}"]`); durationStr = selectedOption ? selectedOption.textContent : formData.eventDuration; } } let summaryHTML = ''; summaryHTML += `<p><strong>Plan Name:</strong> ${formatString(formData.projectName)}</p>`; summaryHTML += `<p><strong>Contact:</strong> ${formatString(formData.firstName)} ${formatString(formData.lastName)} (Age: ${formatAge(formData.age)})</p>`; summaryHTML += `<p><strong>Start Date/Time:</strong> ${startDateTimeStr}</p>`; summaryHTML += `<p><strong>Duration:</strong> ${durationStr}</p>`; summaryHTML += `<p><strong>Location:</strong> ${formatString(formData.city)}, ${formatString(formData.country)}</p>`; summaryHTML += `<p><strong>Event Type:</strong> ${formatString(formData.eventType === 'Other' ? formData.otherEventType : formData.eventType)}</p>`; summaryHTML += `<p><strong>Style/Theme:</strong> ${formatString(formData.eventStyle === 'Other' ? formData.otherEventStyle : formData.eventStyle)}</p>`; summaryHTML += `<p><strong>Guests:</strong> ${formData.numPeople !== null ? formData.numPeople : 'Not Set'}</p>`; summaryHTML += `<p><strong>Food Required:</strong> ${formData.foodNeeded ? (formData.foodNeeded === 'yes' ? 'Yes' : 'No') : 'Not Set'}</p>`; if (formData.foodNeeded === 'yes') { summaryHTML += `<p><strong>Food Style:</strong> ${formatString(formData.foodStyle==='Other'?formData.otherFoodStyle:formData.foodStyle)}</p>`; summaryHTML += `<p><strong>Food Budget/Person:</strong> ${formatCurrency(formData.foodBudgetPerPerson)}</p>`; if(formData.numPeople&&formData.foodBudgetPerPerson!==null){const totalFood=formData.numPeople*formData.foodBudgetPerPerson;summaryHTML+=`<p><strong>Est. Total Food Cost:</strong> ${formatCurrency(totalFood)}</p>`;}else{summaryHTML+=`<p><strong>Est. Total Food Cost:</strong> Not Calculable</p>`;} } summaryHTML += `<p><strong>Total Event Budget:</strong> ${formatCurrency(formData.budget)}</p>`; summaryHTML += `<p><strong>Inspiration Notes:</strong> ${formData.inspirationNotes ? formData.inspirationNotes.replace(/\n/g, '<br>') : 'None'}</p>`; summaryHTML += `<p><strong>Inspiration Photos:</strong> ${hasInspirationPhoto ? `${formData.inspirationPhotosInfo.length} photo(s) added` : 'None uploaded'}</p>`; if (hasInspirationPhoto) { summaryHTML+=`<ul>`;formData.inspirationPhotosInfo.forEach(photo=>{summaryHTML+=`<li>${photo.name} (${(photo.size/1024).toFixed(1)} KB)</li>`;});summaryHTML+=`</ul>`; } summaryContentDiv.innerHTML = summaryHTML; };
                    const resetForm = () => { formData = { ...initialFormData }; formElement.reset(); handleOtherOption(eventTypeSelect, otherEventTypeContainer); handleOtherOption(eventStyleSelect, otherEventStyleContainer); handleOtherOption(foodStyleSelect, otherFoodStyleContainer); handleOtherOption(eventDurationSelect, customDurationContainer); if(inspirationPreview) inspirationPreview.innerHTML = ''; selectedInspirationFiles = []; if (inspirationUploadContainer) inspirationUploadContainer.style.display = 'block'; if(locationStatusArea) hideLocationStatus(); if (citySuggestionsContainer) { citySuggestionsContainer.classList.remove('visible'); citySuggestionsContainer.innerHTML = ''; } if(summaryContentDiv) summaryContentDiv.innerHTML = 'Loading summary...'; if(eventDateInput && eventDateInput._flatpickr) { eventDateInput._flatpickr.clear(); } currentStep = 1; showStep(1); };

                    // --- Form Event Listeners Setup ---
                    if(eventDurationSelect) eventDurationSelect.addEventListener('change', () => handleOtherOption(eventDurationSelect, customDurationContainer));
                    formElement.addEventListener('click', (event) => { const target = event.target; const currentStepElement = target.closest('.form-step'); const stepNum = currentStepElement ? parseInt(currentStepElement.dataset.step, 10) : null; if (isModalCurrentlyVisible && !target.closest('#confirmationModal')) { return; } if (target.classList.contains('next-btn') && stepNum) { event.preventDefault(); collectStepData(stepNum); if (validateStepWithFlag(stepNum)) { let budgetOK = true; if (stepNum === 11) { collectStepData(7); collectStepData(10); collectStepData(11); if (formData.foodNeeded === 'yes' && formData.numPeople && formData.foodBudgetPerPerson >= 0 && formData.budget !== null) { const totalFoodCost = formData.numPeople * formData.foodBudgetPerPerson; const totalBudgetVal = formData.budget; if (totalFoodCost > totalBudgetVal) { budgetOK = false; const formatCurrency = (v) => v !== null && !isNaN(v)?`$${parseFloat(v).toLocaleString()}`:'N/A'; showInfoModalWithFlag("Budget Exceeded", `Cannot proceed: Est. food cost (${formatCurrency(totalFoodCost)}) exceeds total budget (${formatCurrency(totalBudgetVal)}).`); } } } if (budgetOK) { let nextStepNum = stepNum + 1; if (formData.foodNeeded === 'no' && foodSteps.includes(nextStepNum)) { const stepAfterFood = foodSteps[foodSteps.length - 1] + 1; nextStepNum = stepAfterFood; } if (nextStepNum === TOTAL_STEPS) { generateSummary(); } if (nextStepNum <= TOTAL_STEPS) { showStep(nextStepNum); } } } } else if (target.classList.contains('prev-btn') && stepNum) { event.preventDefault(); let prevStepNum = stepNum - 1; if (formData.foodNeeded === 'no' && foodSteps.includes(prevStepNum)) { const stepBeforeFood = foodSteps[0] - 1; prevStepNum = stepBeforeFood; } if (prevStepNum >= 1) { showStep(prevStepNum); } } else if (target.classList.contains('start-over-btn')) { event.preventDefault(); showModalWithFlag( "Confirm Start Over", "All data will be lost.", resetForm ); } else if (target.id === 'getLocationBtn') { event.preventDefault(); handleGetLocation(); } if (citySuggestionsContainer && cityInput && !cityInput.contains(target) && !citySuggestionsContainer.contains(target) && !target.classList.contains('suggestion-item') ) { citySuggestionsContainer.classList.remove('visible'); } });
                    if(modalConfirmBtn) modalConfirmBtn.addEventListener('click', (event) => { event.preventDefault(); event.stopPropagation(); if (typeof confirmCallback === 'function') try { confirmCallback(); } catch (e) { console.error("Callback error:", e); } hideModalWithFlag(); });
                    if(modalCancelBtn) modalCancelBtn.addEventListener('click', (event) => { event.preventDefault(); event.stopPropagation(); hideModalWithFlag(); });
                    if(inspirationPhotosInput) inspirationPhotosInput.addEventListener('change', handleFileSelect);
                    if(eventTypeSelect) eventTypeSelect.addEventListener('change', () => handleOtherOption(eventTypeSelect, otherEventTypeContainer));
                    if(eventStyleSelect) eventStyleSelect.addEventListener('change', () => handleOtherOption(eventStyleSelect, otherEventStyleContainer));
                    if(foodStyleSelect) foodStyleSelect.addEventListener('change', () => handleOtherOption(foodStyleSelect, otherFoodStyleContainer));
                    if(cityInput) cityInput.addEventListener('input', (event) => debouncedFetch(event.target.value));
                    if(cityInput) cityInput.addEventListener('blur', () => { setTimeout(() => { if (citySuggestionsContainer && !citySuggestionsContainer.contains(document.activeElement)) { citySuggestionsContainer.classList.remove('visible'); } }, 150); });
                    formElement.addEventListener('submit', (e) => { e.preventDefault(); if (!validateStepWithFlag(11)) { showStep(11); return; } collectStepData(12); let budgetConflict = false; if (formData.foodNeeded === 'yes' && formData.numPeople && formData.foodBudgetPerPerson >= 0 && formData.budget !== null) { const totalFoodCost = formData.numPeople * formData.foodBudgetPerPerson; const totalBudgetVal = formData.budget; const formatCurrency = (v) => v !== null && !isNaN(v) ? `$${parseFloat(v).toLocaleString()}`:'N/A'; if (totalFoodCost > totalBudgetVal) { budgetConflict = true; showInfoModalWithFlag("Budget Conflict", `Cannot confirm: Food cost (${formatCurrency(totalFoodCost)}) exceeds total budget (${formatCurrency(totalBudgetVal)}).`); } } if (budgetConflict) return; if(submitButton) { submitButton.disabled = true; submitButton.textContent = 'Generating...'; } formData.submittedAt = new Date().toISOString(); console.log('--- FINAL Event Plan Data ---'); console.log(JSON.stringify(formData, null, 2)); console.log('---------------------------'); try { const combinedPrompt = generateAiPrompts(formData); let promptDisplayHtml = '<div style="text-align: left; max-height: 60vh; overflow-y: auto; line-height: 1.5;">'; promptDisplayHtml += `<textarea rows="18" style="width: 95%; font-size: 0.9em; background-color: #4a3f35; color: #f0e5d8; border: 1px solid #6a4f3a; border-radius: 4px; white-space: pre-wrap;" readonly>${combinedPrompt || 'Error generating prompt.'}</textarea>`; promptDisplayHtml += '</div>'; if (!showModalBase(true)) { throw new Error("Modal base failed for prompt display."); } if (!modalTitle || !modalMessage || !modalConfirmBtn || !modalCancelBtn) { throw new Error("Modal content elements missing for prompt display."); } modalTitle.textContent = "Generated AI Prompt (Copy & Test)"; modalMessage.innerHTML = promptDisplayHtml; confirmCallback = null; modalConfirmBtn.textContent = "OK"; modalConfirmBtn.classList.add('ok-button'); modalCancelBtn.classList.add('hidden'); } catch (promptError) { console.error("Error generating or displaying prompt:", promptError); showInfoModalWithFlag("Error", "Could not generate AI prompt. Plan data logged to console."); } finally { if(submitButton) { submitButton.disabled = false; submitButton.textContent = 'Confirm Plan'; } } });
                    formElement.addEventListener('keydown', (event) => { if (event.key !== 'Enter' || event.target.tagName === 'TEXTAREA') { return; } event.preventDefault(); if (isModalCurrentlyVisible) { if (modalConfirmBtn && !modalConfirmBtn.disabled && modalConfirmBtn.offsetParent !== null) { modalConfirmBtn.click(); } return; } const activeStepElement = steps.find(step => step.classList.contains('active-step')); if (!activeStepElement) { return; } const currentStepNum = parseInt(activeStepElement.dataset.step, 10); const submitBtn = activeStepElement.querySelector('#confirmPlanBtn'); if (submitBtn && currentStepNum === TOTAL_STEPS) { submitBtn.click(); } else if (activeStepElement.querySelector('.next-btn')) { collectStepData(currentStepNum); if (validateStepWithFlag(currentStepNum)) { let budgetOK = true; if (currentStepNum === 11) { collectStepData(7); collectStepData(10); collectStepData(11); if (formData.foodNeeded === 'yes' && formData.numPeople && formData.foodBudgetPerPerson >= 0 && formData.budget !== null) { const totalFoodCost = formData.numPeople * formData.foodBudgetPerPerson; const totalBudgetVal = formData.budget; if (totalFoodCost > totalBudgetVal) { budgetOK = false; const formatCurrency = (v) => v !== null && !isNaN(v)?`$${parseFloat(v).toLocaleString()}`:'N/A'; showInfoModalWithFlag("Budget Exceeded", `Cannot proceed: Est. food cost (${formatCurrency(totalFoodCost)}) exceeds total budget (${formatCurrency(totalBudgetVal)}).`); } } } if (budgetOK) { let nextStepNum = currentStepNum + 1; if (formData.foodNeeded === 'no' && foodSteps.includes(nextStepNum)) { const stepAfterFood = foodSteps[foodSteps.length - 1] + 1; nextStepNum = stepAfterFood; } if (nextStepNum === TOTAL_STEPS) { generateSummary(); } if (nextStepNum <= TOTAL_STEPS) { showStep(nextStepNum); } } } } });
                    window.addEventListener('beforeunload', (event) => { let potentiallyUnsavedData = false; if (currentStep > 1) { potentiallyUnsavedData = true; } else { if (document.getElementById('firstName')?.value || document.getElementById('lastName')?.value || document.getElementById('age')?.value) { potentiallyUnsavedData = true; } } if (potentiallyUnsavedData) { event.preventDefault(); event.returnValue = ''; } });

                    // --- Initial Form Setup ---
                    showStep(1);
                    handleOtherOption(eventTypeSelect, otherEventTypeContainer);
                    handleOtherOption(eventStyleSelect, otherEventStyleContainer);
                    handleOtherOption(foodStyleSelect, otherFoodStyleContainer);
                    handleOtherOption(eventDurationSelect, customDurationContainer);
                    hideLocationStatus();
                    console.log("Form Initialization Script Completed.");

                } else {
                     console.log("DOM fully loaded but form not visible. Skipping form script init."); // Should not happen in this version
                }

            }); // End DOMContentLoaded for form logic
        } catch (initError) {
             console.error("FATAL ERROR during form script execution:", initError);
             alert(`Fatal Error: ${initError.message}. Form may not function correctly.`);
        }
    </script>

</body>
</html>