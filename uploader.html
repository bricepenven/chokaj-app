<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Hub</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #1e1e1e; color: #e0e0e0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding-top: 20px; padding-bottom: 20px; }
        .container { background-color: #2d2d2d; padding: 20px 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); width: 100%; max-width: 800px; }
        
        /* Tab System */
        .tab-buttons { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: transparent; border: none; color: #aaa; font-size: 1.1em; border-bottom: 3px solid transparent; margin-right: 10px;}
        .tab-button.active { color: #007bff; border-bottom: 3px solid #007bff; font-weight: bold;}
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        h1 { color: #ffffff; padding-bottom: 10px; margin-top: 0; font-size: 1.6em; text-align: left; }
        h2 { color: #cccccc; margin-top: 20px; margin-bottom: 10px; font-size: 1.2em; }
        
        /* Uploader specific styles */
        #fileInputLabel { display: inline-block; margin-bottom: 15px; padding: 10px 18px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; transition: background-color 0.2s; }
        #fileInputLabel:hover { background-color: #0056b3; }
        #fileInput { display: none; }
        #fileListContainer { margin-bottom: 15px; padding: 0; background-color: #252525; border: 1px solid #383838; border-radius: 6px; min-height: 70px; max-height: 300px; overflow-y: auto; }
        .file-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #383838; transition: background-color 0.2s; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item:hover { background-color: #333333; }
        .file-preview-container { width: 70px; height: 50px; margin-right: 12px; display: flex; align-items: center; justify-content: center; background-color: #1c1c1c; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .file-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .file-info-container { display: flex; align-items: center; flex-grow: 1; }
        .file-details { display: flex; flex-direction: column; }
        .file-name { font-weight: 500; color: #fafafa; display: block; margin-bottom: 3px; word-break: break-all; font-size: 0.95em; }
        .file-size, .status-message { font-size: 0.75em; color: #aaa; }
        .status-container { display: flex; flex-direction: column; align-items: flex-end; min-width: 120px; text-align: right;}
        .status-message { margin-bottom: 4px; font-size: 0.8em; }
        .progress-bar-container { width: 100%; height: 4px; background-color: #444; border-radius: 2px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: #007bff; transition: width 0.1s ease-in-out; }
        .remove-button { padding: 6px 10px; background-color: #c82333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-left: 12px; transition: background-color 0.2s; }
        .remove-button:hover { background-color: #a21020; }
        #processButton { display: block; width: 100%; padding: 12px 18px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.05em; margin-top: 15px; transition: background-color 0.2s; }
        #processButton:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #processButton:hover:not(:disabled) { background-color: #1e7e34; }
        .empty-list-placeholder { color: #777; text-align: center; padding: 20px; }

        /* Database View specific styles */
        #dbFileListContainer { max-height: 400px; overflow-y: auto; border: 1px solid #383838; border-radius: 6px; background-color: #252525;}
        .db-item { padding: 10px 12px; border-bottom: 1px solid #383838; display: flex; align-items: center; }
        .db-item:last-child { border-bottom: none; }
        .db-item-preview { width: 70px; height: 50px; margin-right: 15px; background-color: #1c1c1c; border-radius: 4px; display: flex; align-items: center; justify-content:center; overflow:hidden;}
        .db-item-preview video, .db-item-preview img {max-width:100%; max-height:100%; object-fit:contain;}
        .db-item-info { flex-grow: 1; }
        .db-item-info strong { color: #fafafa; font-size: 0.95em;}
        .db-item-info p { margin: 3px 0; font-size: 0.8em; color: #aaa; word-break: break-all;}
        #refreshDbButton { margin-bottom: 15px; padding: 8px 15px; background-color: #6c757d; color:white; border:none; border-radius:4px; cursor:pointer; }
        #refreshDbButton:hover { background-color: #5a6268; }

    </style>
</head>
<body>
    <div class="container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="uploadTab">Upload Media</button>
            <button class="tab-button" data-tab="databaseTab">View Database</button>
        </div>

        <div id="uploadTab" class="tab-content active">
            <h1>Upload New Media</h1>
            <label for="fileInput" id="fileInputLabel">Select Files</label>
            <input type="file" id="fileInput" accept="video/*,image/*" multiple>
            <h2>Selected for Upload:</h2>
            <div id="fileListContainer">
                <p class="empty-list-placeholder">No files selected yet.</p>
            </div>
            <button id="processButton" disabled>Process Selected Files</button>
        </div>

        <div id="databaseTab" class="tab-content">
            <h1>Media Database (Initial View)</h1>
            <button id="refreshDbButton">Refresh List</button>
            <div id="dbFileListContainer">
                <p class="empty-list-placeholder">Loading database entries...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, serverTimestamp, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAU3qmsD15JX6iwjloTjCPDd-2SuG6oM8w",
            authDomain: "chokaj-4dcae.firebaseapp.com",
            projectId: "chokaj-4dcae",
            storageBucket: "chokaj-4dcae.appspot.com",
            messagingSenderId: "516228224797",
            appId: "1:516228224797:web:6bdf08edb5962aad5633f4",
            measurementId: "G-9QVCF19J2W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Tab Switching Logic ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetTab = button.getAttribute('data-tab');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === targetTab) {
                        content.classList.add('active');
                        if (targetTab === 'databaseTab') {
                            loadDatabaseEntries(); // Load data when tab is selected
                        }
                    }
                });
            });
        });

        // --- Uploader Tab Logic (Mostly same as before) ---
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const processButton = document.getElementById('processButton');
        let filesToUpload = [];

        fileInput.addEventListener('change', handleFileSelect);
        processButton.addEventListener('click', handleProcessFiles);

        function handleFileSelect(event) {
            if (filesToUpload.length === 0 && fileListContainer.querySelector('p.empty-list-placeholder')) {
                fileListContainer.innerHTML = ''; 
            }
            const newFiles = Array.from(event.target.files);
            newFiles.forEach(file => {
                const uniqueFileId = `file-${Date.now()}-${Math.random().toString(36).substring(2)}`;
                if (!filesToUpload.some(f => f.file.name === file.name && f.file.size === file.size)) {
                    const fileEntry = { id: uniqueFileId, file: file, statusElement: null, progressBarElement: null, objectURL: null };
                    filesToUpload.push(fileEntry);
                    renderFilePreview(fileEntry);
                }
            });
            updateProcessButtonState();
            fileInput.value = null; 
        }

        function renderFilePreview(fileEntry) {
            const { id, file } = fileEntry;
            const fileItemDiv = document.createElement('div');
            fileItemDiv.classList.add('file-list-item');
            fileItemDiv.id = id;

            const infoContainer = document.createElement('div');
            infoContainer.classList.add('file-info-container');
            const previewContainer = document.createElement('div');
            previewContainer.classList.add('file-preview-container');
            const previewElement = document.createElement(file.type.startsWith('video/') ? 'video' : 'img');
            previewElement.classList.add('file-preview');
            fileEntry.objectURL = URL.createObjectURL(file);
            previewElement.src = fileEntry.objectURL;
            if (file.type.startsWith('video/')) previewElement.muted = true;
            previewContainer.appendChild(previewElement);
            infoContainer.appendChild(previewContainer);

            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('file-details');
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('file-name');
            nameSpan.textContent = file.name;
            const sizeSpan = document.createElement('span');
            sizeSpan.classList.add('file-size');
            sizeSpan.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            detailsDiv.appendChild(nameSpan);
            detailsDiv.appendChild(sizeSpan);
            infoContainer.appendChild(detailsDiv);
            fileItemDiv.appendChild(infoContainer);

            const statusContainer = document.createElement('div');
            statusContainer.classList.add('status-container');
            const statusMessageSpan = document.createElement('span');
            statusMessageSpan.classList.add('status-message');
            statusMessageSpan.id = `status-${id}`;
            statusMessageSpan.textContent = 'Pending';
            fileEntry.statusElement = statusMessageSpan;
            statusContainer.appendChild(statusMessageSpan);
            
            const progressBarContainer = document.createElement('div');
            progressBarContainer.classList.add('progress-bar-container');
            const progressBar = document.createElement('div');
            progressBar.classList.add('progress-bar');
            progressBar.id = `progress-${id}`;
            progressBarContainer.appendChild(progressBar);
            fileEntry.progressBarElement = progressBar;
            statusContainer.appendChild(progressBarContainer);
            fileItemDiv.appendChild(statusContainer);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-button');
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => {
                const entryToRemove = filesToUpload.find(f => f.id === id);
                if (entryToRemove && entryToRemove.objectURL) URL.revokeObjectURL(entryToRemove.objectURL);
                filesToUpload = filesToUpload.filter(f => f.id !== id);
                const elementToRemove = document.getElementById(id);
                if (elementToRemove) elementToRemove.remove();
                if (filesToUpload.length === 0) fileListContainer.innerHTML = '<p class="empty-list-placeholder">No files selected yet.</p>';
                updateProcessButtonState();
            };
            fileItemDiv.appendChild(removeButton);
            fileListContainer.appendChild(fileItemDiv);
        }

        function updateProcessButtonState() {
            processButton.disabled = filesToUpload.length === 0;
        }

        async function handleProcessFiles() {
            if (filesToUpload.length === 0) { alert("Please select files to upload."); return; }
            processButton.disabled = true;
            processButton.textContent = "Processing Initiated...";
            const filesBeingProcessed = [...filesToUpload];
            filesToUpload = []; 
            updateProcessButtonState();

            for (const fileEntry of filesBeingProcessed) {
                const { id, file, statusElement, progressBarElement, objectURL } = fileEntry;
                const originalFilename = file.name;
                const sanitizedFilename = originalFilename.replace(/[^a-zA-Z0-9._-]/g, '_');
                const gcsFileName = `medias/${Date.now()}_${sanitizedFilename}`;
                
                const revokePreviewUrl = () => { if (objectURL) { URL.revokeObjectURL(objectURL); fileEntry.objectURL = null; }};

                statusElement.textContent = 'Preparing...'; statusElement.style.color = '#bbb'; progressBarElement.style.width = '0%';

                try {
                    statusElement.textContent = 'Creating DB entry...';
                    const safeDocId = gcsFileName.replace(/\//g, '__');
                    const fileDocRef = doc(db, "mediaProcessingQueue", safeDocId); 
                    await setDoc(fileDocRef, {
                        originalFileName: originalFilename, gcsBucket: firebaseConfig.storageBucket,
                        gcsPath: gcsFileName, status: "uploading_to_gcs",
                        uploadInitiatedTimestamp: serverTimestamp(), ui_processed: true,
                        contentType: file.type, size: file.size
                    });

                    statusElement.textContent = 'Uploading...';
                    const storageRef = ref(storage, gcsFileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBarElement.style.width = `${progress}%`;
                            statusElement.textContent = `Uploading ${Math.round(progress)}%`;
                        },
                        async (error) => {
                            console.error(`Upload failed for ${originalFilename}:`, error);
                            statusElement.textContent = 'Upload Failed!'; statusElement.style.color = '#e74c3c';
                            revokePreviewUrl();
                            await setDoc(fileDocRef, { status: "gcs_upload_failed", errorMessage: error.message, errorTimestamp: serverTimestamp() }, { merge: true });
                        },
                        async () => {
                            const firebaseStorageDownloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            statusElement.textContent = 'Upload Complete! Awaiting n8n...'; statusElement.style.color = '#2ecc71';
                            progressBarElement.style.width = '100%';
                            revokePreviewUrl();
                            const gcsPublicUrl = `https://storage.googleapis.com/${firebaseConfig.storageBucket}/${gcsFileName}`;
                            await setDoc(fileDocRef, { 
                                status: "uploaded_to_gcs_pending_twelvelabs", gcsPublicUrlForTwelveLabs: gcsPublicUrl, 
                                firebaseStorageDownloadUrl: firebaseStorageDownloadURL, gcsUploadCompleteTimestamp: serverTimestamp()
                            }, { merge: true });
                        }
                    );
                } catch (error) {
                    console.error(`Error initiating processing for file ${originalFilename}:`, error);
                    statusElement.textContent = `Error: ${error.message || 'Unknown error'}`; statusElement.style.color = '#e74c3c';
                    revokePreviewUrl(); 
                }
            }
            processButton.textContent = "Process Selected Files"; 
        }

        // --- Database Tab Logic ---
        const dbFileListContainer = document.getElementById('dbFileListContainer');
        const refreshDbButton = document.getElementById('refreshDbButton');

        refreshDbButton.addEventListener('click', loadDatabaseEntries);

        async function loadDatabaseEntries() {
            dbFileListContainer.innerHTML = '<p class="empty-list-placeholder">Loading entries...</p>';
            try {
                const q = query(collection(db, "mediaProcessingQueue"), orderBy("uploadInitiatedTimestamp", "desc"), limit(50));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    dbFileListContainer.innerHTML = '<p class="empty-list-placeholder">No media entries found in database.</p>';
                    return;
                }
                dbFileListContainer.innerHTML = ''; // Clear loading message
                querySnapshot.forEach((docSnap) => {
                    renderDbEntry(docSnap.id, docSnap.data());
                });
            } catch (error) {
                console.error("Error fetching database entries:", error);
                dbFileListContainer.innerHTML = '<p class="empty-list-placeholder" style="color:red;">Error loading entries. Check console.</p>';
            }
        }

        function renderDbEntry(docId, data) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('db-item');
            itemDiv.id = `db-${docId}`;

            const previewDiv = document.createElement('div');
            previewDiv.classList.add('db-item-preview');
            
            // Use gcsPublicUrlForTwelveLabs if available and it's an image/video, otherwise a placeholder
            let previewSrc = '';
            if (data.gcsPublicUrlForTwelveLabs && data.contentType) {
                if (data.contentType.startsWith('image/')) {
                    previewSrc = data.gcsPublicUrlForTwelveLabs;
                    const img = document.createElement('img');
                    img.src = previewSrc;
                    previewDiv.appendChild(img);
                } else if (data.contentType.startsWith('video/')) {
                    previewSrc = data.gcsPublicUrlForTwelveLabs;
                    const vid = document.createElement('video');
                    vid.src = previewSrc;
                    vid.muted = true; 
                    // vid.controls = true; // Optionally add controls for small preview
                    vid.onloadedmetadata = () => { if (vid.duration > 5) vid.currentTime = 5; }; // Show a frame
                    previewDiv.appendChild(vid);
                } else {
                     previewDiv.textContent = data.contentType.split('/')[0] || 'File';
                }
            } else {
                previewDiv.textContent = 'Media';
            }
            itemDiv.appendChild(previewDiv);

            const infoDiv = document.createElement('div');
            infoDiv.classList.add('db-item-info');
            infoDiv.innerHTML = `
                <p><strong>Filename:</strong> ${data.originalFileName || 'N/A'}</p>
                <p><strong>GCS Path:</strong> ${data.gcsPath || 'N/A'}</p>
                <p><strong>Status:</strong> ${data.status || 'N/A'}</p>
                <p><strong>Uploaded:</strong> ${data.uploadInitiatedTimestamp ? new Date(data.uploadInitiatedTimestamp.seconds * 1000).toLocaleString() : 'N/A'}</p>
                <p><strong>Content Type:</strong> ${data.contentType || 'N/A'}</p>
                <p><strong>Size:</strong> ${data.size ? (data.size / 1024 / 1024).toFixed(2) + ' MB' : 'N/A'}</p>
            `;
            itemDiv.appendChild(infoDiv);
            dbFileListContainer.appendChild(itemDiv);
        }

        // Optionally load DB entries when page first loads and default tab is Database
        // if (document.querySelector('.tab-button[data-tab="databaseTab"].active')) {
        //    loadDatabaseEntries();
        // }

    </script>
</body>
</html>