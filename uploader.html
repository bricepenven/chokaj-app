
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Media Hub</title>
<style>
    body { background-color: #1e1e1e; color: #e0e0e0; font-family: sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: #2d2d2d; border-radius: 10px; padding: 20px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    .db-item { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; }
    .db-item:hover { background: #444; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
    .modal-content { background: #383838; padding: 20px; border-radius: 10px; max-width: 800px; width: 90%; position: relative; color: #fff; }
    .modal-content video { width: 100%; max-height: 60vh; background: black; margin-bottom: 15px; }
    .modal-content pre { white-space: pre-wrap; background: #222; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .close-btn { position: absolute; top: 10px; right: 15px; color: #fff; font-size: 24px; cursor: pointer; }
    .goal-thumb { width: 140px; margin: 5px; cursor: pointer; }
    .goal-thumb img { width: 100%; border-radius: 4px; border: 1px solid #444; }
    .goal-thumb p { font-size: 0.8em; margin-top: 4px; color: #ccc; }
</style>
</head>
<body>
<div class="container">
    <h1>Media List</h1>
    <div id="mediaList"></div>
</div>

<div class="modal" id="mediaModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle"></h2>
        <video id="modalVideo" controls></video>
        <div id="metadataDisplay"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAU3qmsD15JX6iwjloTjCPDd-2SuG6oM8w",
    authDomain: "chokaj-4dcae.firebaseapp.com",
    projectId: "chokaj-4dcae",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const mediaList = document.getElementById("mediaList");
const modal = document.getElementById("mediaModal");
const modalVideo = document.getElementById("modalVideo");
const modalTitle = document.getElementById("modalTitle");
const metadataDisplay = document.getElementById("metadataDisplay");

function closeModal() {
    modal.style.display = "none";
    modalVideo.pause();
    modalVideo.src = "";
}

window.onclick = function(event) {
    if (event.target == modal) closeModal();
};

function showMediaDetails(data) {
    modalTitle.textContent = data.originalFileName || "Media Details";
    if (data.contentType?.startsWith("video/") && data.gcsPublicUrlForTwelveLabs) {
        modalVideo.src = data.gcsPublicUrlForTwelveLabs;
        modalVideo.style.display = "block";
    } else {
        modalVideo.style.display = "none";
    }

    let html = "<h3>Metadata</h3><ul>";
    for (const key in data) {
        if (typeof data[key] !== "object") html += `<li><strong>${key}:</strong> ${data[key]}</li>`;
    }
    html += "</ul>";

    const goals = data.highlights_goals?.arrayValue?.values || [];
    if (goals.length) {
        html += "<h3>Highlights</h3><div style='display:flex;flex-wrap:wrap;'>";
        goals.forEach(goal => {
            const g = goal.mapValue?.fields || {};
            const thumb = g.thumbnail_url?.stringValue;
            const transcription = g.transcription?.stringValue || "";
            const start = g.start?.doubleValue || 0;
            if (thumb) {
                html += `
                    <div class="goal-thumb" onclick="document.getElementById('modalVideo').currentTime=${start}; document.getElementById('modalVideo').pause();">
                        <img src="${thumb}">
                        <p>${transcription.slice(0, 60)}...</p>
                    </div>`;
            }
        });
        html += "</div>";
    }

    metadataDisplay.innerHTML = html;
    modal.style.display = "flex";
}

async function loadMedia() {
    const qSnap = await getDocs(collection(db, "mediaProcessingQueue"));
    qSnap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "db-item";
        div.innerHTML = `<strong>${data.originalFileName}</strong><br>Status: ${data.status}`;
        div.onclick = () => showMediaDetails(data);
        mediaList.appendChild(div);
    });
}

loadMedia();
</script>
</body>
</html>
