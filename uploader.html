<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Uploader</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #1e1e1e; color: #e0e0e0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding-top: 40px; }
        .container { background-color: #2d2d2d; padding: 25px 30px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); width: 100%; max-width: 700px; }
        h1 { color: #ffffff; border-bottom: 1px solid #444; padding-bottom: 15px; margin-top: 0; font-size: 1.8em; text-align: center; }
        h2 { color: #cccccc; margin-top: 25px; margin-bottom: 10px; font-size: 1.3em; }
        #fileInputLabel { display: block; margin-bottom: 20px; padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; text-align: center; font-size: 1em; transition: background-color 0.2s; }
        #fileInputLabel:hover { background-color: #0056b3; }
        #fileInput { display: none; }
        #fileListContainer { margin-bottom: 20px; padding: 0; background-color: #252525; border: 1px solid #383838; border-radius: 6px; min-height: 80px; max-height: 350px; overflow-y: auto; }
        .file-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #383838; transition: background-color 0.2s; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item:hover { background-color: #333333; }
        .file-preview-container { width: 90px; height: 60px; margin-right: 15px; display: flex; align-items: center; justify-content: center; background-color: #1c1c1c; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .file-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .file-info-container { display: flex; align-items: center; flex-grow: 1; }
        .file-details { display: flex; flex-direction: column; }
        .file-name { font-weight: 500; color: #fafafa; display: block; margin-bottom: 4px; word-break: break-all; }
        .file-size { font-size: 0.8em; color: #aaa; }
        .status-container { display: flex; flex-direction: column; align-items: flex-end; min-width: 150px; text-align: right;}
        .status-message { font-size: 0.85em; color: #bbb; margin-bottom: 5px; }
        .progress-bar-container { width: 100%; height: 5px; background-color: #444; border-radius: 2.5px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: #007bff; transition: width 0.1s ease-in-out; }
        .remove-button { padding: 7px 14px; background-color: #c82333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-left: 15px; transition: background-color 0.2s; }
        .remove-button:hover { background-color: #a21020; }
        #processButton { display: block; width: 100%; padding: 14px 20px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.15em; margin-top: 25px; transition: background-color 0.2s; }
        #processButton:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #processButton:hover:not(:disabled) { background-color: #1e7e34; }
        .empty-list-placeholder { color: #777; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Media Upload Interface</h1>

        <label for="fileInput" id="fileInputLabel">Select Files to Upload</label>
        <input type="file" id="fileInput" accept="video/*,image/*" multiple>

        <h2>Selected Files</h2>
        <div id="fileListContainer">
            <p class="empty-list-placeholder">No files selected yet.</p>
        </div>

        <button id="processButton" disabled>Process Selected Files</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAU3qmsD15JX6iwjloTjCPDd-2SuG6oM8w",
            authDomain: "chokaj-4dcae.firebaseapp.com",
            projectId: "chokaj-4dcae",
            storageBucket: "chokaj-4dcae.appspot.com",
            messagingSenderId: "516228224797",
            appId: "1:516228224797:web:6bdf08edb5962aad5633f4",
            measurementId: "G-9QVCF19J2W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const processButton = document.getElementById('processButton');

        let filesToUpload = []; 

        fileInput.addEventListener('change', handleFileSelect);
        processButton.addEventListener('click', handleProcessFiles);

        function handleFileSelect(event) {
            if (filesToUpload.length === 0 && fileListContainer.querySelector('p.empty-list-placeholder')) {
                fileListContainer.innerHTML = ''; 
            }
            const newFiles = Array.from(event.target.files);
            newFiles.forEach(file => {
                const uniqueFileId = `file-${Date.now()}-${Math.random().toString(36).substring(2)}`;
                if (!filesToUpload.some(f => f.file.name === file.name && f.file.size === file.size)) {
                    const fileEntry = { 
                        id: uniqueFileId, 
                        file: file, 
                        statusElement: null, 
                        progressBarElement: null,
                        objectURL: null // To store the blob URL for later revocation
                    };
                    filesToUpload.push(fileEntry);
                    renderFilePreview(fileEntry);
                }
            });
            updateProcessButtonState();
            fileInput.value = null; 
        }

        function renderFilePreview(fileEntry) {
            const { id, file } = fileEntry;
            const fileItemDiv = document.createElement('div');
            fileItemDiv.classList.add('file-list-item');
            fileItemDiv.id = id;

            const infoContainer = document.createElement('div');
            infoContainer.classList.add('file-info-container');

            const previewContainer = document.createElement('div');
            previewContainer.classList.add('file-preview-container');
            const previewElement = document.createElement(file.type.startsWith('video/') ? 'video' : 'img');
            previewElement.classList.add('file-preview');
            
            fileEntry.objectURL = URL.createObjectURL(file); // Store object URL
            previewElement.src = fileEntry.objectURL;

            if (file.type.startsWith('video/')) {
                previewElement.muted = true;
                // No need to revoke here, will do it after upload or on remove
            }
            previewContainer.appendChild(previewElement);
            infoContainer.appendChild(previewContainer);

            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('file-details');
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('file-name');
            nameSpan.textContent = file.name;
            const sizeSpan = document.createElement('span');
            sizeSpan.classList.add('file-size');
            sizeSpan.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            detailsDiv.appendChild(nameSpan);
            detailsDiv.appendChild(sizeSpan);
            infoContainer.appendChild(detailsDiv);
            
            fileItemDiv.appendChild(infoContainer);

            const statusContainer = document.createElement('div');
            statusContainer.classList.add('status-container');

            const statusMessageSpan = document.createElement('span');
            statusMessageSpan.classList.add('status-message');
            statusMessageSpan.id = `status-${id}`;
            statusMessageSpan.textContent = 'Pending';
            fileEntry.statusElement = statusMessageSpan;
            statusContainer.appendChild(statusMessageSpan);
            
            const progressBarContainer = document.createElement('div');
            progressBarContainer.classList.add('progress-bar-container');
            const progressBar = document.createElement('div');
            progressBar.classList.add('progress-bar');
            progressBar.id = `progress-${id}`;
            progressBarContainer.appendChild(progressBar);
            fileEntry.progressBarElement = progressBar;
            statusContainer.appendChild(progressBarContainer);

            fileItemDiv.appendChild(statusContainer);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-button');
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => {
                const entryToRemove = filesToUpload.find(f => f.id === id);
                if (entryToRemove && entryToRemove.objectURL) {
                    URL.revokeObjectURL(entryToRemove.objectURL); // Revoke on remove
                }
                filesToUpload = filesToUpload.filter(f => f.id !== id);
                const elementToRemove = document.getElementById(id);
                if (elementToRemove) {
                     elementToRemove.remove();
                }
                if (filesToUpload.length === 0) {
                    fileListContainer.innerHTML = '<p class="empty-list-placeholder">No files selected yet.</p>';
                }
                updateProcessButtonState();
            };
            fileItemDiv.appendChild(removeButton);

            fileListContainer.appendChild(fileItemDiv);
        }

        function updateProcessButtonState() {
            processButton.disabled = filesToUpload.length === 0;
        }

        async function handleProcessFiles() {
            if (filesToUpload.length === 0) {
                alert("Please select files to upload.");
                return;
            }

            processButton.disabled = true;
            processButton.textContent = "Processing Initiated...";

            const filesBeingProcessed = [...filesToUpload];
            filesToUpload = []; 
            updateProcessButtonState();

            for (const fileEntry of filesBeingProcessed) {
                const { id, file, statusElement, progressBarElement, objectURL } = fileEntry;
                const originalFilename = file.name;
                const sanitizedFilename = originalFilename.replace(/[^a-zA-Z0-9._-]/g, '_');
                const gcsFileName = `medias/${Date.now()}_${sanitizedFilename}`;
                
                const revokePreviewUrl = () => {
                    if (objectURL) {
                        URL.revokeObjectURL(objectURL);
                        fileEntry.objectURL = null; // Mark as revoked
                    }
                };

                statusElement.textContent = 'Preparing...';
                statusElement.style.color = '#bbb';
                progressBarElement.style.width = '0%';

                try {
                    statusElement.textContent = 'Creating DB entry...';
                    const safeDocId = gcsFileName.replace(/\//g, '__');
                    const fileDocRef = doc(db, "mediaProcessingQueue", safeDocId); 
                    
                    await setDoc(fileDocRef, {
                        originalFileName: originalFilename,
                        gcsBucket: firebaseConfig.storageBucket,
                        gcsPath: gcsFileName, 
                        status: "uploading_to_gcs",
                        uploadInitiatedTimestamp: serverTimestamp(),
                        ui_processed: true,
                        contentType: file.type,
                        size: file.size
                    });

                    statusElement.textContent = 'Uploading...';
                    const storageRef = ref(storage, gcsFileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBarElement.style.width = `${progress}%`;
                            statusElement.textContent = `Uploading ${Math.round(progress)}%`;
                        },
                        async (error) => {
                            console.error(`Upload failed for ${originalFilename}:`, error);
                            statusElement.textContent = 'Upload Failed!';
                            statusElement.style.color = '#e74c3c';
                            revokePreviewUrl();

                            await setDoc(fileDocRef, { 
                                status: "gcs_upload_failed", 
                                errorMessage: error.message,
                                errorTimestamp: serverTimestamp()
                            }, { merge: true });
                        },
                        async () => {
                            const firebaseStorageDownloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            console.log(`File ${originalFilename} uploaded to GCS path (via Firebase Storage): ${gcsFileName}. Firebase URL: ${firebaseStorageDownloadURL}`);
                            statusElement.textContent = 'Upload Complete! n8n processing...';
                            statusElement.style.color = '#2ecc71';
                            progressBarElement.style.width = '100%';
                            revokePreviewUrl();

                            const gcsPublicUrl = `https://storage.googleapis.com/${firebaseConfig.storageBucket}/${gcsFileName}`;
                            await setDoc(fileDocRef, { 
                                status: "uploaded_to_gcs_pending_twelvelabs",
                                gcsPublicUrlForTwelveLabs: gcsPublicUrl, 
                                firebaseStorageDownloadUrl: firebaseStorageDownloadURL,
                                gcsUploadCompleteTimestamp: serverTimestamp()
                            }, { merge: true });
                        }
                    );
                } catch (error) {
                    console.error(`Error initiating processing for file ${originalFilename}:`, error);
                    statusElement.textContent = `Error: ${error.message || 'Unknown error'}`;
                    statusElement.style.color = '#e74c3c';
                    revokePreviewUrl(); 
                }
            }
            processButton.textContent = "Process Selected Files"; 
        }
    </script>
</body>
</html>