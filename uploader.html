<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Hub</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #1e1e1e; color: #e0e0e0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { background-color: #2d2d2d; padding: 20px 25px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); width: 100%; max-width: 900px; }
        
        .tab-buttons { display: flex; border-bottom: 1px solid #4a4a4a; margin-bottom: 25px; }
        .tab-button { padding: 12px 22px; cursor: pointer; background-color: transparent; border: none; color: #b0b0b0; font-size: 1.1em; border-bottom: 3px solid transparent; margin-right: 10px; transition: color 0.2s, border-bottom-color 0.2s; }
        .tab-button.active { color: #007bff; border-bottom: 3px solid #007bff; font-weight: 600;}
        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { color: #ffffff; padding-bottom: 15px; margin-top: 0; font-size: 1.7em; text-align: left; }
        h2 { color: #dddddd; margin-top: 25px; margin-bottom: 12px; font-size: 1.25em; }
        
        #fileInputLabel { display: inline-block; margin-bottom: 18px; padding: 10px 18px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        #fileInputLabel:hover { background-color: #0056b3; }
        #fileInput { display: none; }
        #fileListContainer { margin-bottom: 18px; padding: 0; background-color: #222222; border: 1px solid #404040; border-radius: 6px; min-height: 75px; max-height: 330px; overflow-y: auto; }
        .file-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #3a3a3a; transition: background-color 0.2s; }
        .file-list-item:last-child { border-bottom: none; }
        .file-list-item:hover { background-color: #303030; }
        .file-preview-container { width: 80px; height: 55px; margin-right: 15px; display: flex; align-items: center; justify-content: center; background-color: #181818; border-radius: 4px; overflow: hidden; border: 1px solid #484848; }
        .file-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .file-info-container { display: flex; align-items: center; flex-grow: 1; }
        .file-details { display: flex; flex-direction: column; }
        .file-name { font-weight: 500; color: #f5f5f5; display: block; margin-bottom: 4px; word-break: break-all; font-size: 0.9em; }
        .file-size { font-size: 0.78em; color: #a0a0a0; }
        .status-container { display: flex; flex-direction: column; align-items: flex-end; min-width: 140px; text-align: right;}
        .status-message { margin-bottom: 5px; font-size: 0.8em; color: #b0b0b0; }
        .progress-bar-container { width: 100%; height: 5px; background-color: #484848; border-radius: 2.5px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: #007bff; transition: width 0.1s ease-in-out; }
        .remove-button, .db-remove-button { padding: 7px 12px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-left: 15px; transition: background-color 0.2s; }
        .remove-button:hover, .db-remove-button:hover { background-color: #c9302c; }
        #processButton { display: block; width: 100%; padding: 13px 20px; background-color: #5cb85c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; margin-top: 18px; transition: background-color 0.2s; }
        #processButton:disabled { background-color: #444; color: #777; cursor: not-allowed; }
        #processButton:hover:not(:disabled) { background-color: #449d44; }
        .empty-list-placeholder { color: #888; text-align: center; padding: 25px; font-style: italic; }

        #dbFileListContainer { max-height: 550px; overflow-y: auto; border: 1px solid #404040; border-radius: 6px; background-color: #222222;}
        .db-item { padding: 12px 15px; border-bottom: 1px solid #3a3a3a; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap:18px; cursor:pointer;}
        .db-item:last-child { border-bottom: none; }
        .db-item:hover { background-color: #303030; }
        .db-item-preview { width: 100px; height: 65px; background-color: #181818; border-radius: 4px; display: flex; align-items: center; justify-content:center; overflow:hidden; border: 1px solid #484848;}
        .db-item-preview video, .db-item-preview img {max-width:100%; max-height:100%; object-fit:contain;}
        .db-item-info { flex-grow: 1; }
        .db-item-info strong { color: #f5f5f5; font-size: 1em;}
        .db-item-info p { margin: 4px 0; font-size: 0.85em; color: #a0a0a0; word-break: break-all;}
        #refreshDbButton { margin-bottom: 18px; padding: 9px 16px; background-color: #5bc0de; color:white; border:none; border-radius:5px; cursor:pointer; transition: background-color 0.2s;}
        #refreshDbButton:hover { background-color: #31b0d5; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; animation: fadeInModal 0.3s; }
        .modal-content { background-color: #383838; margin: auto; padding: 25px; border: 1px solid #505050; width: 90%; max-width: 750px; border-radius: 10px; position: relative; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        .modal-close { color: #ccc; float: right; font-size: 30px; font-weight: bold; position: absolute; top: 10px; right: 20px;}
        .modal-close:hover, .modal-close:focus { color: #fff; text-decoration: none; cursor: pointer; }
        .modal-content video { width: 100%; max-height: 75vh; border-radius: 6px; background-color: #000; }
        .modal-content h3 { margin-top:0; color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-content h4 { color: #ddd; margin-top: 20px; margin-bottom: 8px; }
        .modal-content pre { background-color: #222222; padding: 12px; border-radius: 6px; color: #ccc; max-height: 250px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; border: 1px solid #484848;}
        @keyframes fadeInModal { from {opacity:0; transform: scale(0.95);} to {opacity:1; transform: scale(1);} }
    </style>
</head>
<body>
    <div class="container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="uploadTab">Upload Media</button>
            <button class="tab-button" data-tab="databaseTab">View Database</button>
        </div>

        <div id="uploadTab" class="tab-content active">
            <h1>Upload New Media</h1>
            <label for="fileInput" id="fileInputLabel">Select Files</label>
            <input type="file" id="fileInput" accept="video/*,image/*" multiple>
            <h2>Selected for Upload:</h2>
            <div id="fileListContainer">
                <p class="empty-list-placeholder">No files selected yet.</p>
            </div>
            <button id="processButton" disabled>Process Selected Files</button>
        </div>

        <div id="databaseTab" class="tab-content">
            <h1>Media Database</h1>
            <button id="refreshDbButton">Refresh List</button>
            <div id="dbFileListContainer">
                <p class="empty-list-placeholder">Loading database entries...</p>
            </div>
        </div>
    </div>

    <div id="mediaModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modalCloseButton">&times;</span>
            <h3 id="modalTitle">Media Details</h3>
            <div id="modalVideoPlayerContainer" style="display:none; margin-bottom:15px;">
                <video id="modalVideoPlayer" controls muted width="100%"></video>
            </div>
            <h4>All Metadata:</h4>
            <pre id="modalMetadata"></pre>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, serverTimestamp, getDocs, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject as deleteFileFromStorage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // YOUR WEB APP'S FIREBASE CONFIGURATION - ENSURE THIS IS CORRECT
        const firebaseConfig = {
            apiKey: "AIzaSyAU3qmsD15JX6iwjloTjCPDd-2SuG6oM8w",
            authDomain: "chokaj-4dcae.firebaseapp.com",
            projectId: "chokaj-4dcae",
            storageBucket: "chokaj-4dcae.firebasestorage.app", // <<<< CRITICAL: THIS IS YOUR TARGET BUCKET
            messagingSenderId: "516228224797",
            appId: "1:516228224797:web:6bdf08edb5962aad5633f4",
            measurementId: "G-9QVCF19J2W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app); // This points to the bucket in firebaseConfig.storageBucket

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const mediaModal = document.getElementById('mediaModal');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const modalTitle = document.getElementById('modalTitle');
        const modalVideoPlayerContainer = document.getElementById('modalVideoPlayerContainer');
        const modalVideoPlayer = document.getElementById('modalVideoPlayer');
        const modalMetadata = document.getElementById('modalMetadata');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetTab = button.getAttribute('data-tab');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === targetTab) {
                        content.classList.add('active');
                        if (targetTab === 'databaseTab') {
                            loadDatabaseEntries(); 
                        }
                    }
                });
            });
        });

        modalCloseButton.onclick = () => {
            modalVideoPlayer.pause();
            modalVideoPlayer.src = ''; 
            mediaModal.style.display = "none";
        }
        window.onclick = (event) => {
            if (event.target == mediaModal) {
                modalVideoPlayer.pause();
                modalVideoPlayer.src = '';
                mediaModal.style.display = "none";
            }
        }

        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const processButton = document.getElementById('processButton');
        let filesToUpload = []; 

        fileInput.addEventListener('change', handleFileSelect);
        processButton.addEventListener('click', handleProcessFiles);

        function handleFileSelect(event) {
            if (filesToUpload.length === 0 && fileListContainer.querySelector('p.empty-list-placeholder')) {
                fileListContainer.innerHTML = ''; 
            }
            const newFiles = Array.from(event.target.files);
            newFiles.forEach(file => {
                const uniqueFileId = `file-${Date.now()}-${Math.random().toString(36).substring(2)}`;
                if (!filesToUpload.some(f => f.file.name === file.name && f.file.size === file.size)) {
                    const fileEntry = { id: uniqueFileId, file: file, statusElement: null, progressBarElement: null, objectURL: null };
                    filesToUpload.push(fileEntry);
                    renderFilePreview(fileEntry);
                }
            });
            updateProcessButtonState();
            fileInput.value = null; 
        }

        function renderFilePreview(fileEntry) {
            const { id, file } = fileEntry;
            const fileItemDiv = document.createElement('div');
            fileItemDiv.classList.add('file-list-item');
            fileItemDiv.id = id;

            const infoContainer = document.createElement('div');
            infoContainer.classList.add('file-info-container');
            const previewContainer = document.createElement('div');
            previewContainer.classList.add('file-preview-container');
            const previewElement = document.createElement(file.type.startsWith('video/') ? 'video' : 'img');
            previewElement.classList.add('file-preview');
            fileEntry.objectURL = URL.createObjectURL(file);
            previewElement.src = fileEntry.objectURL;
            if (file.type.startsWith('video/')) previewElement.muted = true;
            previewContainer.appendChild(previewElement);
            infoContainer.appendChild(previewContainer);

            const detailsDiv = document.createElement('div');
            detailsDiv.classList.add('file-details');
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('file-name');
            nameSpan.textContent = file.name;
            const sizeSpan = document.createElement('span');
            sizeSpan.classList.add('file-size');
            sizeSpan.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            detailsDiv.appendChild(nameSpan);
            detailsDiv.appendChild(sizeSpan);
            infoContainer.appendChild(detailsDiv);
            fileItemDiv.appendChild(infoContainer);

            const statusContainer = document.createElement('div');
            statusContainer.classList.add('status-container');
            const statusMessageSpan = document.createElement('span');
            statusMessageSpan.classList.add('status-message');
            statusMessageSpan.id = `status-${id}`;
            statusMessageSpan.textContent = 'Pending';
            fileEntry.statusElement = statusMessageSpan;
            statusContainer.appendChild(statusMessageSpan);
            
            const progressBarContainer = document.createElement('div');
            progressBarContainer.classList.add('progress-bar-container');
            const progressBar = document.createElement('div');
            progressBar.classList.add('progress-bar');
            progressBar.id = `progress-${id}`;
            progressBarContainer.appendChild(progressBar);
            fileEntry.progressBarElement = progressBar;
            statusContainer.appendChild(progressBarContainer);
            fileItemDiv.appendChild(statusContainer);

            const removeButton = document.createElement('button');
            removeButton.classList.add('remove-button');
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => {
                const entryToRemove = filesToUpload.find(f => f.id === id);
                if (entryToRemove && entryToRemove.objectURL) URL.revokeObjectURL(entryToRemove.objectURL);
                filesToUpload = filesToUpload.filter(f => f.id !== id);
                const elementToRemove = document.getElementById(id);
                if (elementToRemove) elementToRemove.remove();
                if (filesToUpload.length === 0) fileListContainer.innerHTML = '<p class="empty-list-placeholder">No files selected yet.</p>';
                updateProcessButtonState();
            };
            fileItemDiv.appendChild(removeButton);
            fileListContainer.appendChild(fileItemDiv);
        }

        function updateProcessButtonState() {
            processButton.disabled = filesToUpload.length === 0;
        }

        async function handleProcessFiles() {
            if (filesToUpload.length === 0) { alert("Please select files to upload."); return; }
            processButton.disabled = true;
            processButton.textContent = "Processing Initiated...";
            const filesBeingProcessed = [...filesToUpload];
            filesToUpload = []; 
            updateProcessButtonState();

            for (const fileEntry of filesBeingProcessed) {
                const { id, file, statusElement, progressBarElement, objectURL } = fileEntry;
                const originalFilename = file.name;
                const sanitizedFilename = originalFilename.replace(/[^a-zA-Z0-9._-]/g, '_');
                const gcsFileName = `medias/${Date.now()}_${sanitizedFilename}`;
                
                const revokePreviewUrl = () => { if (objectURL) { URL.revokeObjectURL(objectURL); fileEntry.objectURL = null; }};

                statusElement.textContent = 'Preparing...'; statusElement.style.color = '#bbb'; progressBarElement.style.width = '0%';

                try {
                    statusElement.textContent = 'Creating DB entry...';
                    const safeDocId = gcsFileName.replace(/\//g, '__');
                    const fileDocRef = doc(db, "mediaProcessingQueue", safeDocId); 
                    await setDoc(fileDocRef, {
                        originalFileName: originalFilename, gcsBucket: firebaseConfig.storageBucket,
                        gcsPath: gcsFileName, status: "uploading_to_gcs",
                        uploadInitiatedTimestamp: serverTimestamp(), ui_processed: true,
                        contentType: file.type, size: file.size
                    });

                    statusElement.textContent = 'Uploading...';
                    const storageRef = ref(storage, gcsFileName); // Uploads to firebaseConfig.storageBucket
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBarElement.style.width = `${progress}%`;
                            statusElement.textContent = `Uploading ${Math.round(progress)}%`;
                        },
                        async (error) => {
                            console.error(`Upload failed for ${originalFilename}:`, error);
                            statusElement.textContent = 'Upload Failed!'; statusElement.style.color = '#e74c3c';
                            revokePreviewUrl();
                            await setDoc(fileDocRef, { status: "gcs_upload_failed", errorMessage: error.message, errorTimestamp: serverTimestamp() }, { merge: true });
                        },
                        async () => {
                            const firebaseStorageDownloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            statusElement.textContent = 'Upload Complete! Awaiting n8n...'; statusElement.style.color = '#2ecc71';
                            progressBarElement.style.width = '100%';
                            revokePreviewUrl();
                            const gcsPublicUrl = `https://storage.googleapis.com/${firebaseConfig.storageBucket}/${gcsFileName}`;
                            await setDoc(fileDocRef, { 
                                status: "uploaded_to_gcs_pending_twelvelabs", gcsPublicUrlForTwelveLabs: gcsPublicUrl, 
                                firebaseStorageDownloadUrl: firebaseStorageDownloadURL, gcsUploadCompleteTimestamp: serverTimestamp()
                            }, { merge: true });
                            if (document.getElementById('databaseTab').classList.contains('active')) {
                                loadDatabaseEntries();
                            }
                        }
                    );
                } catch (error) {
                    console.error(`Error initiating processing for file ${originalFilename}:`, error);
                    statusElement.textContent = `Error: ${error.message || 'Unknown error'}`; statusElement.style.color = '#e74c3c';
                    revokePreviewUrl(); 
                }
            }
            processButton.textContent = "Process Selected Files"; 
        }

        const dbFileListContainer = document.getElementById('dbFileListContainer');
        const refreshDbButton = document.getElementById('refreshDbButton');

        refreshDbButton.addEventListener('click', loadDatabaseEntries);

        async function loadDatabaseEntries() {
            dbFileListContainer.innerHTML = '<p class="empty-list-placeholder">Loading entries...</p>';
            try {
                const q = query(collection(db, "mediaProcessingQueue"), orderBy("uploadInitiatedTimestamp", "desc"), limit(25));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    dbFileListContainer.innerHTML = '<p class="empty-list-placeholder">No media entries found.</p>';
                    return;
                }
                dbFileListContainer.innerHTML = ''; 
                querySnapshot.forEach((docSnap) => {
                    renderDbEntry(docSnap.id, docSnap.data());
                });
            } catch (error) {
                console.error("Error fetching database entries:", error);
                dbFileListContainer.innerHTML = '<p class="empty-list-placeholder" style="color:red;">Error loading entries. Check console.</p>';
            }
        }

        function renderDbEntry(docId, data) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('db-item');
            itemDiv.id = `dbItem-${docId}`; // Ensure unique ID for the DB item div
            
            const previewDiv = document.createElement('div');
            previewDiv.classList.add('db-item-preview');
            previewDiv.onclick = () => showMediaDetails(data); 

            if (data.gcsPublicUrlForTwelveLabs && data.contentType) {
                if (data.contentType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = data.gcsPublicUrlForTwelveLabs; 
                    previewDiv.appendChild(img);
                } else if (data.contentType.startsWith('video/')) {
                    const vid = document.createElement('video');
                    vid.src = data.gcsPublicUrlForTwelveLabs; 
                    vid.muted = true; 
                    vid.onloadedmetadata = () => { if (vid.duration > 1) vid.currentTime = 1; };
                    previewDiv.appendChild(vid);
                } else {
                     previewDiv.textContent = data.contentType.split('/')[0] || 'File';
                }
            } else {
                previewDiv.textContent = 'Media';
            }
            itemDiv.appendChild(previewDiv);

            const infoDiv = document.createElement('div');
            infoDiv.classList.add('db-item-info');
            infoDiv.onclick = () => showMediaDetails(data); 
            infoDiv.innerHTML = `
                <p><strong>${data.originalFileName || 'N/A'}</strong></p>
                <p style="font-size:0.75em;">GCS: ${data.gcsPath || 'N/A'}</p>
                <p>Status: <span style="font-weight:bold; color:${getStatusColor(data.status)}">${data.status || 'N/A'}</span></p>
                <p style="font-size:0.75em;">Uploaded: ${data.uploadInitiatedTimestamp ? new Date(data.uploadInitiatedTimestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
            `;
            itemDiv.appendChild(infoDiv);

            const removeDbButton = document.createElement('button');
            removeDbButton.classList.add('db-remove-button');
            removeDbButton.textContent = 'Delete';
            removeDbButton.onclick = async (event) => {
                event.stopPropagation(); 
                if (confirm(`Are you sure you want to remove '${data.originalFileName}'? This will delete the database entry and the file from Cloud Storage.`)) {
                    const button = event.target; // Get the button element
                    button.disabled = true;
                    button.textContent = 'Deleting...';
                    
                    try {
                        console.log(`Attempting to delete Firestore document: mediaProcessingQueue/${docId}`);
                        await deleteDoc(doc(db, "mediaProcessingQueue", docId));
                        console.log(`Document ${docId} successfully deleted from Firestore.`);

                        if (data.gcsPath) {
                            console.log(`Attempting to delete GCS file: ${data.gcsPath}`);
                            const storageFileRef = ref(storage, data.gcsPath);
                            await deleteFileFromStorage(storageFileRef);
                            console.log(`File ${data.gcsPath} successfully deleted from GCS.`);
                        }
                        
                        const uiItemToRemove = document.getElementById(`dbItem-${docId}`);
                        if (uiItemToRemove) uiItemToRemove.remove(); 

                        if (dbFileListContainer.children.length === 0) {
                             dbFileListContainer.innerHTML = '<p class="empty-list-placeholder">No media entries found.</p>';
                        }
                    } catch (err) {
                        console.error("Error removing entry:", err);
                        alert(`Failed to remove entry: ${err.message}`);
                        button.textContent = 'Delete Failed'; 
                        button.style.backgroundColor = '#dc3545'; 
                        setTimeout(() => {
                           if(document.getElementById(`dbItem-${docId}`)) { 
                             button.disabled = false;
                             button.textContent = 'Delete';
                             button.style.backgroundColor = '#c82333'; 
                           }
                        }, 3000);
                    }
                }
            };
            itemDiv.appendChild(removeDbButton);
            dbFileListContainer.appendChild(itemDiv);
        }
        
        function getStatusColor(status) {
            if (!status) return '#bbb';
            status = status.toLowerCase();
            if (status.includes('failed')) return '#e74c3c'; // red
            if (status.includes('complete') || status.includes('pending_twelvelabs') || status.includes('uploaded_to_gcs')) return '#2ecc71'; // green
            if (status.includes('uploading') || status.includes('processing')) return '#3498db'; // blue
            return '#bbb'; // default
        }

        function showMediaDetails(data) {
            modalTitle.textContent = data.originalFileName || "Media Details";

            // Handle video
            if (data.contentType?.startsWith('video/') && data.gcsPublicUrlForTwelveLabs) {
                modalVideoPlayerContainer.style.display = 'block';
                modalVideoPlayer.src = data.gcsPublicUrlForTwelveLabs;
                modalVideoPlayer.load(); // Good practice to call load() after changing src
            } else {
                modalVideoPlayerContainer.style.display = 'none';
                modalVideoPlayer.src = ''; // Clear src if no video
            }

            // Create metadata sections
            let html = `<h4>General Info:</h4><ul>`;
            // Displaying key-value pairs more robustly
            const generalInfoKeys = ['originalFileName', 'contentType', 'size', 'status'];
            generalInfoKeys.forEach(key => {
                if (data[key] !== undefined && data[key] !== null) {
                     html += `<li><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> ${data[key]}</li>`;
                }
            });
            html += `</ul><h4>Upload Info:</h4><ul>`;
            const uploadInfoKeys = ['uploadInitiatedTimestamp', 'gcsUploadCompleteTimestamp', 'gcsPath', 'firebaseStorageDownloadUrl', 'gcsPublicUrlForTwelveLabs'];
            uploadInfoKeys.forEach(key => {
                if (data[key] !== undefined && data[key] !== null) {
                    let value = data[key];
                    if (key.includes('Timestamp') && value && typeof value.seconds === 'number') {
                        value = new Date(value.seconds * 1000).toLocaleString();
                    }
                    html += `<li><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> ${value}</li>`;
                }
            });
            html += `</ul>`;

            // Highlights section - CORRECTED PART
            if (data.highlights_goals && Array.isArray(data.highlights_goals) && data.highlights_goals.length > 0) {
                html += `<h4>Highlights (Goals):</h4><div style="display: flex; flex-wrap: wrap; gap: 12px;">`;
                data.highlights_goals.forEach((goal, index) => {
                    // Ensure 'goal' is a valid object
                    if (goal && typeof goal === 'object') {
                        // Direct access to properties, assuming 'goal' is a plain JS object
                        const start = goal.start; // e.g., 10.5 (number)
                        const thumb = goal.thumbnail_url; // e.g., "http://..." (string)
                        const transcription = goal.transcription || ''; // e.g., "Goal scored" (string)

                        // Check if essential properties exist and have expected types
                        if (typeof thumb === 'string' && thumb.trim() !== '' && typeof start === 'number' && !isNaN(start)) {
                            html += `
                                <div style="width:140px; cursor:pointer;" onclick="if(document.getElementById('modalVideoPlayer')) { document.getElementById('modalVideoPlayer').currentTime = ${start}; document.getElementById('modalVideoPlayer').play(); }">
                                    <img src="${thumb}" style="width:100%; border-radius:4px; border:1px solid #444;" alt="Highlight ${index + 1} thumbnail"/>
                                    <p style="font-size: 0.75em; margin-top: 4px; color: #ccc; word-wrap: break-word;">${transcription.slice(0, 60)}${transcription.length > 60 ? '...' : ''}</p>
                                </div>`;
                        } else {
                            console.warn("Skipping highlight item due to missing/invalid 'thumbnail_url' or 'start'. Goal data:", goal);
                        }
                    } else {
                        console.warn("Skipping highlight item because it's not a valid object:", goal);
                    }
                });
                html += `</div>`;
            }

            modalMetadata.innerHTML = html;
            mediaModal.style.display = "flex";
        }
    </script>
</body>
</html>